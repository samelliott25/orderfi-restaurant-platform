<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrderFi Staff Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #FFF9F5;
      --card: #FFFFFF;
      --text: #2D2A26;
      --text-muted: #6B6560;
      --primary: #E23D28;
      --primary-dark: #C4311F;
      --accent: #FF6B35;
      --fresh: #4CAF50;
      --warm: #FFB347;
      --border: rgba(0,0,0,0.08);
      --success: #4CAF50;
      --error: #E23D28;
    }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    .serif {
      font-family: 'Playfair Display', Georgia, serif;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .admin-nav { display: flex; gap: 1rem; align-items: center; }
    .admin-nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; }
    .admin-nav a:hover, .admin-nav a.active { color: white; }
    
    .logo {
      font-family: 'Lilita One', cursive;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    
    .logo a {
      color: inherit;
      text-decoration: none;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }
    
    .logout-btn {
      background: var(--cream);
      border: none;
      color: var(--charcoal);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .logout-btn:hover {
      background: white;
      transform: translateY(-1px);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .page-title {
      font-family: 'Lilita One', cursive;
      font-size: 2.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--charcoal);
    }
    
    .page-subtitle {
      color: var(--muted);
      margin-bottom: 2rem;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 1rem;
    }
    
    .tab {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: var(--text);
      background: rgba(0,0,0,0.05);
    }
    
    .tab.active {
      color: white;
      background: var(--primary);
    }
    
    .content-panel {
      display: none;
    }
    
    .content-panel.active {
      display: block;
    }

    .kds-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
    .kds-stats-bar { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .kds-stat-pill { display: flex; align-items: center; gap: 0.4rem; padding: 0.45rem 0.9rem; border-radius: 50px; font-size: 0.85rem; font-weight: 600; }
    .kds-stat-pill.new-pill { background: rgba(226,61,40,0.12); color: var(--primary); }
    .kds-stat-pill.prep-pill { background: rgba(245,158,11,0.12); color: #f59e0b; }
    .kds-stat-pill.ready-pill { background: rgba(76,175,80,0.12); color: var(--fresh); }
    .kds-clock-inline { font-size: 1.1rem; font-weight: 700; color: var(--text-muted); font-variant-numeric: tabular-nums; }

    .kds-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; min-height: 400px; }
    .kds-col { background: white; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    .kds-col-head { padding: 0.75rem 1rem; font-family: 'Lilita One', cursive; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.04em; display: flex; align-items: center; gap: 0.5rem; }
    .kds-col-count { font-family: 'Inter', sans-serif; font-size: 0.75rem; background: rgba(0,0,0,0.08); padding: 0.1rem 0.45rem; border-radius: 10px; }
    .col-head-new { background: rgba(226,61,40,0.08); color: var(--primary); border-bottom: 3px solid var(--primary); }
    .col-head-prep { background: rgba(245,158,11,0.08); color: #d97706; border-bottom: 3px solid #f59e0b; }
    .col-head-ready { background: rgba(76,175,80,0.08); color: #2e7d32; border-bottom: 3px solid var(--fresh); }
    .kds-col-body { flex: 1; overflow-y: auto; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.75rem; max-height: 60vh; }

    .kds-order { background: var(--bg); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
    .kds-order.urgent { border-left: 4px solid var(--primary); }
    .kds-order.warning { border-left: 4px solid #f59e0b; }
    .kds-order.ok { border-left: 4px solid var(--fresh); }
    .kds-order-head { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.75rem; background: rgba(0,0,0,0.02); }
    .kds-order-id { font-family: 'Lilita One', cursive; font-size: 1.1rem; }
    .kds-order-table { background: rgba(0,0,0,0.06); padding: 0.15rem 0.5rem; border-radius: 5px; font-size: 0.75rem; font-weight: 600; }
    .kds-order-type { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.04em; padding: 0.12rem 0.35rem; border-radius: 4px; font-weight: 600; }
    .kds-order-type.dine_in { background: rgba(99,102,241,0.12); color: #6366f1; }
    .kds-order-type.takeaway { background: rgba(245,158,11,0.12); color: #f59e0b; }
    .kds-order-timer { font-size: 0.8rem; font-weight: 600; font-variant-numeric: tabular-nums; color: var(--text-muted); }
    .kds-order-timer.urgent { color: var(--primary); }
    .kds-order-timer.warning { color: #f59e0b; }
    .kds-order-items { padding: 0.4rem 0.75rem; }
    .kds-order-item { display: flex; gap: 0.4rem; padding: 0.25rem 0; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
    .kds-order-item:last-child { border-bottom: none; }
    .kds-order-item-qty { font-weight: 700; color: var(--primary); min-width: 22px; }
    .kds-order-item-name { flex: 1; }
    .kds-order-note { margin: 0 0.75rem 0.4rem; padding: 0.4rem 0.6rem; background: rgba(245,158,11,0.1); border-radius: 6px; border-left: 3px solid #f59e0b; font-size: 0.75rem; color: #d97706; }
    .kds-order-actions { padding: 0.4rem 0.6rem; display: flex; gap: 0.4rem; }
    .kds-btn { flex: 1; padding: 0.5rem; border: none; border-radius: 8px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; font-family: inherit; }
    .kds-btn:active { transform: scale(0.97); }
    .kds-btn-start { background: #f59e0b; color: #000; }
    .kds-btn-start:hover { background: #fbbf24; }
    .kds-btn-ready { background: var(--fresh); color: #000; }
    .kds-btn-ready:hover { background: #66bb6a; }
    .kds-btn-complete { background: #6366f1; color: white; }
    .kds-btn-complete:hover { background: #818cf8; }
    .kds-btn-bump { background: rgba(0,0,0,0.06); color: var(--text-muted); }
    .kds-btn-bump:hover { background: rgba(0,0,0,0.1); }
    .kds-empty { text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.85rem; opacity: 0.7; }

    @media (max-width: 900px) {
      .kds-grid { grid-template-columns: 1fr; }
      .kds-col-body { max-height: 40vh; }
    }

    .add-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.85rem 1.75rem;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(226, 61, 40, 0.3);
    }
    
    .add-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(226, 61, 40, 0.4);
    }
    
    .add-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .scan-btn {
      background: var(--text);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .scan-btn:hover {
      background: #555;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .scan-upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg);
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .scan-upload-area:hover {
      border-color: var(--primary);
      background: rgba(226, 61, 40, 0.03);
    }
    
    .scan-upload-area.has-image {
      border-style: solid;
      border-color: var(--primary);
      padding: 1rem;
    }
    
    .scan-progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    .scan-progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .scan-result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 0.4rem;
      font-size: 0.85rem;
    }
    
    .scan-result-item .item-cat {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 2px 6px;
      background: rgba(226,61,40,0.08);
      border-radius: 10px;
    }
    
    .menu-grid {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    
    .category-section {
      background: var(--card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      border: 1px solid var(--border);
    }
    
    .category-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
      cursor: pointer;
      user-select: none;
      transition: opacity 0.2s;
    }
    .category-header:hover {
      opacity: 0.8;
    }
    .category-chevron {
      margin-left: 0.5rem;
      width: 20px;
      height: 20px;
      transition: transform 0.3s ease;
      flex-shrink: 0;
      color: var(--text-muted);
    }
    .category-section.collapsed .category-chevron {
      transform: rotate(-90deg);
    }
    .category-section.collapsed .category-header {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom-color: transparent;
    }
    .category-section.collapsed .category-items {
      max-height: 0;
      opacity: 0;
    }
    
    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .category-icon.starters { background: rgba(255, 179, 71, 0.2); }
    .category-icon.bar-snacks { background: rgba(255, 179, 71, 0.2); }
    .category-icon.buffalo-wings { background: rgba(226, 61, 40, 0.2); }
    .category-icon.burgers { background: rgba(226, 61, 40, 0.15); }
    .category-icon.dawgs { background: rgba(255, 179, 71, 0.2); }
    .category-icon.tacos { background: rgba(255, 107, 53, 0.2); }
    .category-icon.from-our-grill { background: rgba(226, 61, 40, 0.2); }
    .category-icon.plant-powered { background: rgba(76, 175, 80, 0.2); }
    .category-icon.sides { background: rgba(76, 175, 80, 0.15); }
    .category-icon.desserts { background: rgba(255, 107, 53, 0.15); }
    .category-icon.drinks { background: rgba(33, 150, 243, 0.15); }
    .category-icon.uncategorized { background: rgba(0, 0, 0, 0.08); }
    
    .category-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.35rem;
      color: var(--text);
    }
    
    .category-count {
      background: var(--primary);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
      margin-left: auto;
    }
    
    .category-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.25rem;
      overflow: hidden;
      transition: max-height 0.35s ease, opacity 0.25s ease;
      max-height: 5000px;
      opacity: 1;
    }
    
    .menu-card {
      background: var(--card);
      border-radius: 20px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }
    
    .menu-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }
    
    .card-image {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #f8f4f0 0%, #eee8e2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      position: relative;
      overflow: hidden;
    }
    
    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .card-image .placeholder {
      font-size: 4rem;
      opacity: 0.8;
    }
    
    .card-content {
      padding: 1.25rem;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .card-name {
      font-family: 'Lilita One', cursive;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .card-price {
      color: var(--primary);
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .card-category {
      display: inline-block;
      background: var(--olive);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--cream);
    }
    
    .dietary-badge {
      display: inline-block;
      background: var(--green-fresh);
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      color: white;
    }
    
    .card-desc {
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    
    .card-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .keyword-tag {
      background: rgba(255, 107, 53, 0.15);
      color: var(--accent);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    
    .keyword-weight {
      opacity: 0.7;
      margin-left: 0.25rem;
    }
    
    .card-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .card-btn {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .card-btn.edit {
      background: var(--olive);
      color: var(--cream);
    }
    
    .card-btn.edit:hover {
      background: var(--orange);
    }
    
    .card-btn.delete {
      background: transparent;
      color: var(--error);
      border: 1px solid var(--error);
    }
    
    .card-btn.delete:hover {
      background: var(--error);
      color: white;
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(42, 42, 42, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: var(--card);
      border-radius: 24px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .modal-close {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--text);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: 500;
    }
    
    .form-hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .photo-upload {
      border: 2px dashed var(--olive);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--cream);
    }
    
    .photo-upload:hover {
      border-color: var(--orange);
      background: rgba(232, 112, 63, 0.05);
    }
    
    .photo-upload.has-image {
      padding: 0;
      border: none;
    }
    
    .photo-upload img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
    }
    
    .photo-upload-text {
      color: var(--muted);
    }
    
    .photo-upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }
    
    .keywords-editor {
      background: var(--cream);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid rgba(0,0,0,0.08);
    }
    
    .keyword-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    
    .keyword-input {
      flex: 2;
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--charcoal);
      font-family: inherit;
    }
    
    .keyword-weight-input {
      flex: 1;
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--charcoal);
      font-family: inherit;
      text-align: center;
    }
    
    .keyword-remove {
      background: transparent;
      border: none;
      color: var(--error);
      cursor: pointer;
      padding: 0.5rem;
      font-size: 1.25rem;
      line-height: 1;
    }
    
    .add-keyword-btn {
      background: transparent;
      border: 1px dashed var(--olive);
      color: var(--olive-dark);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      width: 100%;
      margin-top: 0.5rem;
      transition: all 0.2s;
    }
    
    .add-keyword-btn:hover {
      border-color: var(--orange);
      color: var(--orange);
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(0,0,0,0.08);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid var(--muted);
      color: var(--charcoal);
    }
    
    .btn-secondary:hover {
      border-color: var(--charcoal);
    }
    
    .btn-primary {
      background: var(--orange);
      border: none;
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(232, 112, 63, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .orders-table th, .orders-table td {
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    .orders-table th {
      background: var(--olive);
      color: var(--cream);
      font-weight: 500;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-pending {
      background: var(--yellow);
      color: var(--charcoal);
    }
    
    .status-preparing {
      background: var(--teal);
      color: white;
    }
    
    .status-ready {
      background: var(--green-fresh);
      color: white;
    }
    
    .status-completed {
      background: rgba(113, 113, 122, 0.2);
      color: #71717a;
    }
    
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: var(--olive);
    }
    
    .login-card {
      background: white;
      border-radius: 24px;
      padding: 3rem;
      text-align: center;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    
    .login-logo {
      font-family: 'Lilita One', cursive;
      font-size: 2rem;
      font-weight: 700;
      color: var(--orange);
      margin-bottom: 1rem;
    }
    
    .login-title {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    .login-subtitle {
      color: var(--muted);
      margin-bottom: 2rem;
    }
    
    .replit-login-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
    }
    
    .replit-login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--accent-glow);
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      color: var(--muted);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--dark-surface);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--muted);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.25rem;
      color: var(--charcoal);
      margin-bottom: 0.5rem;
    }
    
    .availability-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .toggle {
      width: 44px;
      height: 24px;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle.active {
      background: var(--green-fresh);
    }
    
    .toggle::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .toggle.active::after {
      transform: translateX(20px);
    }
    
    .hidden { display: none !important; }
    
    /* Configuration Panel Styles */
    .config-sections {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .config-section {
      background: var(--card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }
    
    .config-section-header {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .config-icon {
      width: 48px;
      height: 48px;
      background: rgba(226, 61, 40, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .config-section-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.25rem;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    
    .config-section-desc {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .config-form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    
    .config-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .config-label {
      font-weight: 500;
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .config-input, .config-select, .config-textarea {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .config-input:focus, .config-select:focus, .config-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(226, 61, 40, 0.1);
    }
    
    .config-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .config-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .config-toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .config-toggle-row:last-of-type {
      border-bottom: none;
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 28px;
      transition: 0.3s;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--fresh);
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    .config-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .config-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 50px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    
    .config-btn.primary {
      background: var(--primary);
      color: white;
    }
    
    .config-btn.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .config-btn.secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .config-btn.secondary:hover {
      background: #f0ebe6;
    }
    
    .config-status {
      padding: 1rem;
      border-radius: 10px;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    .config-status.success {
      background: rgba(76, 175, 80, 0.15);
      color: #2e7d32;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .config-status.error {
      background: rgba(226, 61, 40, 0.15);
      color: #c62828;
      border: 1px solid rgba(226, 61, 40, 0.3);
    }
    
    .config-status.info {
      background: rgba(33, 150, 243, 0.15);
      color: #1565c0;
      border: 1px solid rgba(33, 150, 243, 0.3);
    }
    
    /* WYSIWYG Receipt Preview Styles */
    .receipt-preview-container {
      display: flex;
      gap: 2rem;
      margin-top: 1.5rem;
    }
    
    .receipt-paper {
      background: #fff;
      padding: 1.5rem 1rem;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.4;
      min-width: 280px;
      max-width: 320px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border-radius: 2px;
      position: relative;
    }
    
    .receipt-paper::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 0;
      right: 0;
      height: 8px;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 3px,
        #e0e0e0 3px,
        #e0e0e0 6px
      );
    }
    
    .receipt-paper.width-58 {
      min-width: 200px;
      max-width: 220px;
      font-size: 10px;
      padding: 1rem 0.75rem;
    }
    
    .receipt-line {
      padding: 3px 6px;
      margin: 1px 0;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s;
      position: relative;
    }
    
    .receipt-line:hover {
      background: rgba(226, 61, 40, 0.08);
    }
    
    .receipt-line.selected {
      background: rgba(226, 61, 40, 0.15);
      box-shadow: inset 0 0 0 2px var(--primary);
    }
    
    .receipt-line.editing {
      background: rgba(226, 61, 40, 0.1);
    }
    
    .receipt-line.dimmed {
      opacity: 0.3 !important;
      text-decoration: line-through !important;
    }
    
    .receipt-line.dimmed * {
      opacity: 0.3 !important;
      text-decoration: line-through !important;
    }
    
    .price-dimmed {
      opacity: 0.3 !important;
      text-decoration: line-through !important;
    }
    
    /* Order Detail Modal Styles */
    .order-detail {
      padding: 8px;
    }
    
    .order-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0e6db;
    }
    
    .order-id-large {
      font-family: 'Lilita One', cursive;
      font-size: 24px;
      color: var(--charcoal);
    }
    
    .order-detail-section {
      margin-bottom: 20px;
    }
    
    .order-section-title {
      font-family: 'Lilita One', cursive;
      font-size: 14px;
      color: var(--primary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .order-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .order-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .order-info-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .order-info-value {
      font-size: 14px;
      color: var(--charcoal);
      font-weight: 500;
    }
    
    .order-items-list {
      background: #f8f4f0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .order-item-row {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e8e0db;
      gap: 12px;
    }
    
    .order-item-row:last-child {
      border-bottom: none;
    }
    
    .refund-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .item-qty {
      font-weight: bold;
      color: var(--primary);
      min-width: 30px;
    }
    
    .item-name {
      flex: 1;
      color: var(--charcoal);
    }
    
    .item-price {
      font-weight: 600;
      color: var(--charcoal);
    }
    
    .order-totals {
      background: #f8f4f0;
      border-radius: 8px;
      padding: 12px;
    }
    
    .order-total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed #e8e0db;
    }
    
    .order-total-row:last-child {
      border-bottom: none;
    }
    
    .order-total-row.total {
      font-weight: bold;
      font-size: 16px;
      color: var(--charcoal);
      border-bottom: 2px solid var(--primary);
      margin-bottom: 8px;
    }
    
    .print-status-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .print-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .print-status.printed {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .print-status.not-printed {
      background: #fff3e0;
      color: #e65100;
    }
    
    .print-time {
      font-size: 12px;
      color: #888;
    }
    
    .order-time {
      font-size: 14px;
      color: var(--charcoal);
    }
    
    .order-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 2px solid #f0e6db;
    }
    
    .btn-warning {
      background: #FFB347;
      color: #6b3e00;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-warning:hover {
      background: #ffa726;
    }
    
    .btn-danger {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-danger:hover {
      background: #c62828;
    }
    
    .status-badge.status-refunded {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status-badge.status-partial-refund {
      background: #fff3e0;
      color: #e65100;
    }
    
    .orders-table tr.order-row:hover {
      background: #fff9f5;
    }
    
    /* Expandable Order Rows */
    .expand-arrow {
      display: inline-block;
      margin-right: 8px;
      color: #888;
      font-size: 10px;
      transition: transform 0.2s ease;
    }
    
    .expand-arrow.expanded {
      color: var(--primary);
    }
    
    .order-expand-row {
      background: #faf6f2;
    }
    
    .order-expand-row td {
      padding: 0 !important;
      border-top: none !important;
    }
    
    .order-expand-content {
      padding: 20px;
      border-top: 2px solid #f0e6db;
      animation: slideDown 0.2s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .order-expand-detail {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .order-expand-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .order-expand-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .order-expand-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .order-expand-col {
      min-width: 0;
    }
    
    .order-expand-info {
      font-size: 13px;
      line-height: 1.6;
      color: #555;
    }
    
    .order-expand-items {
      font-size: 13px;
    }
    
    .order-expand-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed #e8e0db;
    }
    
    .order-expand-item:last-child {
      border-bottom: none;
    }
    
    .order-expand-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .order-expand-item .item-qty {
      font-weight: bold;
      color: var(--primary);
      min-width: 24px;
      font-size: 12px;
    }
    
    .order-expand-item .item-name {
      flex: 1;
      font-size: 13px;
    }
    
    .order-expand-item .item-price {
      font-weight: 600;
      font-size: 12px;
    }
    
    .order-expand-totals {
      font-size: 13px;
    }
    
    .total-line {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }
    
    .total-line.total {
      font-weight: bold;
      border-top: 1px solid #e8e0db;
      padding-top: 8px;
      margin-top: 4px;
    }
    
    .order-expand-status {
      font-size: 13px;
    }
    
    .order-expand-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #f0e6db;
    }
    
    .btn-small {
      padding: 8px 12px !important;
      font-size: 12px !important;
    }
    
    /* Receipt Type Tabs */
    .receipt-type-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .receipt-type-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: #fff;
      border: 2px solid #e8e0db;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .receipt-type-tab:hover {
      border-color: var(--primary);
      background: #fff9f5;
    }
    
    .receipt-type-tab.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, #fff9f5 0%, #ffe5e0 100%);
      box-shadow: 0 4px 12px rgba(226, 61, 40, 0.15);
    }
    
    .receipt-type-tab .tab-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .receipt-type-tab .tab-label {
      font-family: 'Lilita One', cursive;
      font-size: 16px;
      color: var(--charcoal);
    }
    
    .receipt-type-tab .tab-desc {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    
    .receipt-type-tab.active .tab-label {
      color: var(--primary);
    }
    
    .receipt-type-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #f8f4f0;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #666;
    }
    
    .receipt-type-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    
    .receipt-type-badge.kitchen {
      background: #FFB347;
      color: #6b3e00;
    }
    
    .receipt-type-badge.tax {
      background: #4CAF50;
      color: #fff;
    }
    
    .config-hint-box {
      padding: 12px 16px;
      background: #fffbeb;
      border: 1px solid #f0e6c8;
      border-radius: 8px;
      font-size: 13px;
      color: #856404;
      margin-top: 8px;
    }
    
    .config-hint-box strong {
      color: #664d00;
    }
    
    /* Kitchen Receipt Preview Styles */
    .receipt-paper.kitchen-receipt {
      border-top: 4px solid #FFB347;
    }
    
    .receipt-paper.tax-receipt {
      border-top: 4px solid #4CAF50;
    }
    
    .receipt-type-indicator {
      text-align: center;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 4px;
    }
    
    .receipt-type-indicator.kitchen {
      background: #fff3e0;
      color: #e65100;
    }
    
    .receipt-type-indicator.tax {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .kitchen-large-text {
      font-size: 24px !important;
      font-weight: bold !important;
    }
    
    .kitchen-instructions {
      font-style: italic;
      color: #c00;
      font-size: 13px;
      padding: 4px 0;
      border-top: 1px dashed #ddd;
      margin-top: 4px;
    }
    
    .receipt-line-edit {
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--primary);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 10px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
    }
    
    .receipt-line:hover .receipt-line-edit {
      opacity: 1;
    }
    
    .receipt-header {
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .receipt-subheader {
      text-align: center;
      font-size: 10px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .receipt-divider {
      border: none;
      border-top: 1px dashed #999;
      margin: 8px 0;
    }
    
    .receipt-divider-double {
      border-top: 2px solid #333;
    }
    
    .receipt-row {
      display: flex;
      justify-content: space-between;
    }
    
    .receipt-row-qty {
      display: grid;
      grid-template-columns: 25px 1fr auto;
      gap: 4px;
    }
    
    .receipt-total-row {
      font-weight: bold;
      font-size: 14px;
    }
    
    .receipt-footer-text {
      text-align: center;
      margin-top: 12px;
      font-size: 10px;
    }
    
    .receipt-barcode {
      text-align: center;
      margin-top: 10px;
      font-family: 'Libre Barcode 39', cursive;
      font-size: 36px;
      letter-spacing: -2px;
    }
    
    .receipt-timestamp {
      text-align: center;
      font-size: 10px;
      color: #666;
    }
    
    .receipt-hidden {
      display: none !important;
    }
    
    .receipt-edit-panel {
      flex: 1;
      background: var(--card);
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid var(--border);
      min-height: 200px;
    }
    
    .edit-panel-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }
    
    .edit-panel-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }
    
    .edit-panel-title {
      font-family: 'Lilita One', cursive;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .edit-field-group {
      margin-bottom: 1rem;
    }
    
    .edit-field-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    
    .edit-field-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
    
    .edit-field-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(226, 61, 40, 0.1);
    }
    
    .line-type-badge {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(226, 61, 40, 0.1);
      color: var(--primary);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .edit-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .edit-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .edit-btn.apply {
      background: var(--primary);
      color: white;
    }
    
    .edit-btn.apply:hover {
      background: var(--primary-dark);
    }
    
    .edit-btn.reset {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    @media (max-width: 768px) {
      .receipt-preview-container {
        flex-direction: column;
      }
      
      .receipt-paper {
        margin: 0 auto;
      }
    }
    
    .filter-bar {
      background: white;
      border-radius: 16px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    
    .filter-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .filter-label {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .filter-chips {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .filter-chip {
      background: var(--cream);
      border: 1px solid rgba(0,0,0,0.1);
      color: var(--muted);
      padding: 0.4rem 0.85rem;
      border-radius: 20px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .filter-chip:hover {
      color: var(--charcoal);
      border-color: var(--olive);
    }
    
    .filter-chip.active {
      background: var(--orange);
      color: white;
      border-color: var(--orange);
    }
    
    .filter-chip.dietary {
      background: transparent;
      border: 1px solid var(--olive);
      color: var(--olive-dark);
    }
    
    .filter-chip.dietary.active {
      background: var(--green-fresh);
      border-color: var(--green-fresh);
      color: white;
    }
    
    .search-input {
      background: var(--cream);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      padding: 0.5rem 1rem;
      color: var(--charcoal);
      font-family: inherit;
      font-size: 0.9rem;
      min-width: 200px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--orange);
    }
    
    .search-input::placeholder {
      color: var(--muted);
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .item-count {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-input {
        width: 100%;
      }
    }
    
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .tag-option {
      background: var(--cream);
      border: 1px solid rgba(0,0,0,0.1);
      color: var(--muted);
      padding: 0.4rem 0.75rem;
      border-radius: 20px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .tag-option:hover {
      border-color: var(--orange);
      color: var(--charcoal);
    }
    
    .tag-option.selected {
      background: var(--green-fresh);
      border-color: var(--green-fresh);
      color: white;
    }
    
    .tag-option.allergen.selected {
      background: var(--coral);
      border-color: var(--coral);
      color: white;
    }
    
    .custom-tag-add {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .custom-tag-add .form-input {
      flex: 1;
    }
    
    .btn-add-tag {
      background: var(--orange);
      color: white;
      border: none;
      width: 40px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.25rem;
      transition: all 0.2s;
    }
    
    .btn-add-tag:hover {
      transform: scale(1.05);
    }
    
    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .custom-tag {
      background: var(--orange);
      border: none;
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .custom-tag .remove-tag {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
      opacity: 0.8;
    }
    
    .custom-tag .remove-tag:hover {
      opacity: 1;
    }

    /* === Ghost Guide Overlay === */
    .ghost-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      pointer-events: none;
    }
    .ghost-overlay.active {
      display: block;
    }
    .ghost-backdrop {
      position: fixed;
      inset: 0;
      pointer-events: auto;
    }
    .ghost-spotlight {
      position: fixed;
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10001;
      pointer-events: none;
    }
    .ghost-spotlight::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 14px;
      border: 2px solid var(--accent);
      animation: ghost-pulse 1.8s ease-in-out infinite;
    }
    @keyframes ghost-pulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.02); }
    }
    .ghost-tooltip {
      position: fixed;
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 340px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 10002;
      pointer-events: auto;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      transform: translateY(10px);
    }
    .ghost-tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .ghost-tooltip-step {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .ghost-tooltip-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 0.4rem;
    }
    .ghost-tooltip-body {
      font-size: 0.88rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    .ghost-tooltip-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .ghost-tooltip-dots {
      display: flex;
      gap: 6px;
    }
    .ghost-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }
    .ghost-dot.active {
      background: var(--accent);
      transform: scale(1.3);
    }
    .ghost-dot.done {
      background: var(--fresh);
    }
    .ghost-btn {
      border: none;
      border-radius: 50px;
      padding: 0.5rem 1.1rem;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ghost-btn-skip {
      background: transparent;
      color: var(--text-muted);
    }
    .ghost-btn-skip:hover {
      color: var(--text);
    }
    .ghost-btn-next {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
    }
    .ghost-btn-next:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(226, 61, 40, 0.3);
    }
    .ghost-btn-back {
      background: var(--bg);
      color: var(--text);
    }
    .ghost-btn-back:hover {
      background: #eee;
    }
    .ghost-start-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #FF6B35 0%, #FFB347 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 0.6rem 1.2rem;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    .ghost-start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
    }
    .ghost-start-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* === AI Copilot Widget === */
    .copilot-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(226, 61, 40, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .copilot-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(226, 61, 40, 0.5);
    }
    .copilot-fab svg {
      width: 28px;
      height: 28px;
      fill: white;
    }
    .copilot-fab .fab-close {
      display: none;
      font-size: 24px;
      color: white;
      line-height: 1;
    }
    .copilot-fab.open svg { display: none; }
    .copilot-fab.open .fab-close { display: block; }

    .copilot-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 18px;
      height: 18px;
      background: var(--fresh);
      border-radius: 50%;
      border: 2px solid white;
      display: none;
    }

    .copilot-panel {
      position: fixed;
      bottom: 96px;
      right: 24px;
      width: 380px;
      max-height: 520px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 999;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .copilot-panel.open {
      display: flex;
      animation: copilotSlideUp 0.3s ease;
    }
    @keyframes copilotSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .copilot-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .copilot-header-icon {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .copilot-header-text h3 {
      color: white;
      font-family: 'Lilita One', cursive;
      font-size: 1.1rem;
      margin: 0;
    }
    .copilot-header-text p {
      color: rgba(255,255,255,0.8);
      font-size: 0.75rem;
      margin: 0;
    }

    .copilot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 340px;
      min-height: 200px;
    }

    .copilot-msg {
      max-width: 88%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 0.88rem;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .copilot-msg.assistant {
      background: var(--bg);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .copilot-msg.user {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .copilot-msg.assistant .msg-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .copilot-typing {
      display: none;
      align-self: flex-start;
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 14px;
      border-bottom-left-radius: 4px;
    }
    .copilot-typing.visible { display: block; }
    .copilot-typing-dots {
      display: flex;
      gap: 4px;
    }
    .copilot-typing-dots span {
      width: 7px;
      height: 7px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: typingBounce 1.2s infinite;
    }
    .copilot-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .copilot-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }

    .copilot-input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .copilot-input {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 10px 16px;
      font-size: 0.88rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      background: var(--bg);
    }
    .copilot-input:focus {
      border-color: var(--primary);
    }
    .copilot-send-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .copilot-send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    .copilot-send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    .copilot-send-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    .copilot-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 0 16px 12px;
    }
    .copilot-quick-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 0.78rem;
      font-family: inherit;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s;
    }
    .copilot-quick-btn:hover {
      background: rgba(226, 61, 40, 0.08);
      border-color: var(--primary);
      color: var(--primary);
    }

    .copilot-feedback-tag {
      display: inline-block;
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 6px;
      font-weight: 600;
    }
    .copilot-feedback-tag.bug { background: rgba(226,61,40,0.1); color: var(--primary); }
    .copilot-feedback-tag.confusion { background: rgba(255,179,71,0.2); color: #B8860B; }
    .copilot-feedback-tag.feature_request { background: rgba(33,150,243,0.1); color: #1976D2; }
    .copilot-feedback-tag.praise { background: rgba(76,175,80,0.1); color: var(--fresh); }
  </style>
</head>
<body>
  <div id="dashboard-view" class="">
    <header class="header">
      <div class="logo"><a href="/">OrderFi</a></div>
      <nav class="admin-nav">
        <a href="/">Home</a>
        <a href="/order">Voice Order</a>
        <a href="/menu/loose-moose">Menu</a>
        <a href="/admin?tab=kitchen">Kitchen</a>
        <a href="/admin" class="active">Dashboard</a>
      </nav>
      <div class="user-info">
        <a href="/" class="logout-btn">Back to Home</a>
      </div>
    </header>

    <main class="container">
      <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.5rem;">
        <div>
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Manage your menu and view orders</p>
        </div>
        <button class="ghost-start-btn" id="ghost-start-btn" onclick="startGhostGuide()">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          Take a Tour
        </button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="menu">Menu Items</button>
        <button class="tab" data-tab="orders">Recent Orders</button>
        <button class="tab" data-tab="kitchen">Kitchen</button>
        <button class="tab" data-tab="config">Configuration</button>
      </div>

      <div id="menu-panel" class="content-panel active">
        <div class="filter-bar">
          <div class="filter-section">
            <span class="filter-label">Category:</span>
            <div class="filter-chips" id="category-filters">
              <button class="filter-chip active" data-filter="all">All</button>
              <button class="filter-chip" data-filter="Starters">Starters</button>
              <button class="filter-chip" data-filter="Bar Snacks">Bar Snacks</button>
              <button class="filter-chip" data-filter="Buffalo Wings">Wings</button>
              <button class="filter-chip" data-filter="Burgers">Burgers</button>
              <button class="filter-chip" data-filter="Dawgs">Dawgs</button>
              <button class="filter-chip" data-filter="Tacos">Tacos</button>
              <button class="filter-chip" data-filter="From our grill">Grill</button>
              <button class="filter-chip" data-filter="Plant Powered">Plant Powered</button>
            </div>
          </div>
          <div class="filter-section">
            <span class="filter-label">Dietary:</span>
            <div class="filter-chips" id="dietary-filters">
              <button class="filter-chip dietary" data-dietary="vegetarian">Vegetarian</button>
              <button class="filter-chip dietary" data-dietary="vegan">Vegan</button>
              <button class="filter-chip dietary" data-dietary="gluten-free">Gluten-Free</button>
              <button class="filter-chip dietary" data-dietary="spicy">Spicy</button>
            </div>
          </div>
          <div class="filter-section">
            <input type="text" class="search-input" id="menu-search" placeholder="Search menu items..." oninput="applyFilters()">
          </div>
        </div>
        <div class="menu-header">
          <button class="add-btn" onclick="openAddModal()">
            <span>+</span> Add Menu Item
          </button>
          <button class="add-btn scan-btn" onclick="openScanModal()">
            <span></span> Scan Menu
          </button>
          <span class="item-count" id="item-count"></span>
        </div>
        <div id="menu-grid" class="menu-grid">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <div id="orders-panel" class="content-panel">
        <div id="orders-container">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <div id="kitchen-panel" class="content-panel">
        <div class="kds-toolbar">
          <div class="kds-stats-bar">
            <div class="kds-stat-pill new-pill"><span id="kds-new-count">0</span> New</div>
            <div class="kds-stat-pill prep-pill"><span id="kds-prep-count">0</span> Preparing</div>
            <div class="kds-stat-pill ready-pill"><span id="kds-ready-count">0</span> Ready</div>
          </div>
          <div class="kds-clock-inline" id="kds-clock">00:00</div>
        </div>
        <div class="kds-grid">
          <div class="kds-col">
            <div class="kds-col-head col-head-new">New Orders <span class="kds-col-count" id="kds-new-head">0</span></div>
            <div class="kds-col-body" id="kds-new-orders"></div>
          </div>
          <div class="kds-col">
            <div class="kds-col-head col-head-prep">Preparing <span class="kds-col-count" id="kds-prep-head">0</span></div>
            <div class="kds-col-body" id="kds-prep-orders"></div>
          </div>
          <div class="kds-col">
            <div class="kds-col-head col-head-ready">Ready <span class="kds-col-count" id="kds-ready-head">0</span></div>
            <div class="kds-col-body" id="kds-ready-orders"></div>
          </div>
        </div>
        <audio id="kds-ding" preload="auto">
          <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" type="audio/wav">
        </audio>
      </div>

      <div id="config-panel" class="content-panel">
        <div class="config-sections">
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-icon"></div>
              <div>
                <h3 class="config-section-title">WiFi Printing</h3>
                <p class="config-section-desc">Configure network printer for order receipts</p>
              </div>
            </div>
            
            <div class="config-form">
              <div class="config-toggle-row">
                <label class="config-label">Enable WiFi Printing</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="printer-enabled">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-field">
                <label class="config-label" for="printer-ip">Printer IP Address</label>
                <input type="text" class="config-input" id="printer-ip" placeholder="192.168.1.100">
                <p class="config-hint">The local network IP address of your receipt printer</p>
              </div>
              
              <div class="config-field">
                <label class="config-label" for="printer-port">Port</label>
                <input type="number" class="config-input" id="printer-port" placeholder="9100" value="9100">
                <p class="config-hint">Default port for most network printers is 9100</p>
              </div>
              
              <div class="config-field">
                <label class="config-label" for="printer-type">Printer Type</label>
                <select class="config-select" id="printer-type">
                  <option value="escpos">ESC/POS (Epson, Star, etc.)</option>
                  <option value="zpl">ZPL (Zebra)</option>
                  <option value="raw">Raw Text</option>
                </select>
              </div>
              
              <div class="config-field">
                <label class="config-label" for="printer-width">Paper Width</label>
                <select class="config-select" id="printer-width" onchange="updateReceiptPreview()">
                  <option value="58">58mm (2.25")</option>
                  <option value="80" selected>80mm (3.15")</option>
                </select>
              </div>
              
              <div class="config-actions">
                <button class="config-btn secondary" onclick="testPrinter()">
                  <span></span> Test Connection
                </button>
                <button class="config-btn primary" onclick="saveConfig()">
                  <span></span> Save Settings
                </button>
              </div>
              
              <div id="printer-status" class="config-status" style="display: none;"></div>
            </div>
          </div>
          
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-icon"></div>
              <div>
                <h3 class="config-section-title">Receipt Settings</h3>
                <p class="config-section-desc">Configure kitchen and customer receipts separately</p>
              </div>
            </div>
            
            <!-- Receipt Type Tabs -->
            <div class="receipt-type-tabs">
              <button class="receipt-type-tab active" data-type="kitchen" onclick="switchReceiptType('kitchen')">
                <span class="tab-icon"></span>
                <span class="tab-label">Kitchen Receipt</span>
                <span class="tab-desc">For kitchen staff</span>
              </button>
              <button class="receipt-type-tab" data-type="tax" onclick="switchReceiptType('tax')">
                <span class="tab-icon"></span>
                <span class="tab-label">Customer Receipt</span>
                <span class="tab-desc">Tax receipt for customers</span>
              </button>
            </div>
            
            <!-- Kitchen Receipt Settings -->
            <div class="config-form receipt-settings-panel" id="kitchen-settings">
              <div class="receipt-type-header">
                <span class="receipt-type-badge kitchen">KITCHEN</span>
                <span>What the kitchen sees when preparing orders</span>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print order number (large)</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="kitchen-order-number" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print table/pickup number</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="kitchen-table-number" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print item quantities (large)</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="kitchen-quantities" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print special instructions</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="kitchen-instructions" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print order time</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="kitchen-time" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-hint-box">
                <strong>Tip:</strong> Kitchen receipts focus on what staff need to prepare the order. Prices and customer details are hidden by default.
              </div>
            </div>
            
            <!-- Tax Receipt Settings -->
            <div class="config-form receipt-settings-panel" id="tax-settings" style="display: none;">
              <div class="receipt-type-header">
                <span class="receipt-type-badge tax">CUSTOMER</span>
                <span>What customers receive with their order</span>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print order number</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-order-number" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print customer name</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-customer-name" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print itemized prices</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-prices" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print tax breakdown</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-tax" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print payment method</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-payment" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-toggle-row">
                <label class="config-label">Print barcode</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="print-barcode" checked onchange="updateReceiptVisibility()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="config-field">
                <label class="config-label" for="receipt-footer">Receipt Footer Message</label>
                <textarea class="config-textarea" id="receipt-footer" placeholder="Thank you for your order!" oninput="updateReceiptPreview()"></textarea>
              </div>
            </div>
          </div>
          
          <!-- WYSIWYG Receipt Preview -->
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-icon"></div>
              <div>
                <h3 class="config-section-title">Receipt Preview</h3>
                <p class="config-section-desc">Click on any line to customize it. Changes update in real-time.</p>
              </div>
            </div>
            
            <div class="receipt-preview-container">
              <!-- Kitchen Receipt Preview -->
              <div id="receipt-paper-kitchen" class="receipt-paper kitchen-receipt">
                <div class="receipt-type-indicator kitchen"> Kitchen Copy</div>
                
                <!-- Large Order Number -->
                <div class="receipt-line" data-line="kitchen-order" data-type="header" id="kitchen-order-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-header kitchen-large-text">ORDER #1234</div>
                </div>
                
                <!-- Table/Pickup Number -->
                <div class="receipt-line" data-line="kitchen-table" data-type="info" id="kitchen-table-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-row" style="justify-content: center; font-size: 18px; font-weight: bold;">
                    <span> Table 5</span>
                  </div>
                </div>
                
                <!-- Order Time -->
                <div class="receipt-line" data-line="kitchen-time" data-type="info" id="kitchen-time-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-timestamp">12:34 PM</div>
                </div>
                
                <hr class="receipt-divider receipt-divider-double">
                
                <!-- Order Items (Large Quantities, No Prices) -->
                <div class="receipt-line" data-line="kitchen-item-1" data-type="item" id="kitchen-item-1" onclick="selectReceiptLine(this)">
                  <div class="receipt-row" style="font-size: 16px;">
                    <span style="font-size: 20px; font-weight: bold; min-width: 40px;">2x</span>
                    <span style="flex: 1;">Classic Burger</span>
                  </div>
                  <div class="kitchen-instructions" id="kitchen-instructions-1"> No onions, extra pickles</div>
                </div>
                <div class="receipt-line" data-line="kitchen-item-2" data-type="item" id="kitchen-item-2" onclick="selectReceiptLine(this)">
                  <div class="receipt-row" style="font-size: 16px;">
                    <span style="font-size: 20px; font-weight: bold; min-width: 40px;">1x</span>
                    <span style="flex: 1;">Caesar Salad</span>
                  </div>
                  <div class="kitchen-instructions" id="kitchen-instructions-2"> Dressing on the side</div>
                </div>
                <div class="receipt-line" data-line="kitchen-item-3" data-type="item" id="kitchen-item-3" onclick="selectReceiptLine(this)">
                  <div class="receipt-row" style="font-size: 16px;">
                    <span style="font-size: 20px; font-weight: bold; min-width: 40px;">2x</span>
                    <span style="flex: 1;">Craft Soda</span>
                  </div>
                </div>
                
                <hr class="receipt-divider receipt-divider-double">
                
                <div style="text-align: center; font-size: 12px; color: #666; padding: 8px;">
                  Kitchen Copy - Not for Customer
                </div>
              </div>
              
              <!-- Tax Receipt Preview (Customer Copy) -->
              <div id="receipt-paper-tax" class="receipt-paper tax-receipt" style="display: none;">
                <div class="receipt-type-indicator tax"> Customer Copy</div>
                
                <!-- Receipt Header -->
                <div class="receipt-line" data-line="restaurant-name" data-type="header" onclick="selectReceiptLine(this)">
                  <div class="receipt-header">OrderFi Restaurant</div>
                </div>
                <div class="receipt-line" data-line="restaurant-address" data-type="subheader" onclick="selectReceiptLine(this)">
                  <div class="receipt-subheader">123 Main Street, City<br>Tel: (555) 123-4567</div>
                </div>
                
                <hr class="receipt-divider">
                
                <!-- Order Info -->
                <div class="receipt-line" data-line="order-number" data-type="info" id="receipt-order-number" onclick="selectReceiptLine(this)">
                  <div class="receipt-row">
                    <span>Order #:</span>
                    <span>ORD-1234</span>
                  </div>
                </div>
                <div class="receipt-line" data-line="customer-name" data-type="info" id="receipt-customer-name" onclick="selectReceiptLine(this)">
                  <div class="receipt-row">
                    <span>Customer:</span>
                    <span>John D.</span>
                  </div>
                </div>
                <div class="receipt-line" data-line="timestamp" data-type="info" onclick="selectReceiptLine(this)">
                  <div class="receipt-timestamp">Jan 28, 2026 12:34 PM</div>
                </div>
                
                <hr class="receipt-divider receipt-divider-double">
                
                <!-- Order Items with Prices -->
                <div class="receipt-line" data-line="item-1" data-type="item" onclick="selectReceiptLine(this)">
                  <div class="receipt-row-qty" id="receipt-item-1">
                    <span>2x</span>
                    <span>Classic Burger</span>
                    <span>$25.98</span>
                  </div>
                </div>
                <div class="receipt-line" data-line="item-2" data-type="item" onclick="selectReceiptLine(this)">
                  <div class="receipt-row-qty" id="receipt-item-2">
                    <span>1x</span>
                    <span>Caesar Salad</span>
                    <span>$11.99</span>
                  </div>
                </div>
                <div class="receipt-line" data-line="item-3" data-type="item" onclick="selectReceiptLine(this)">
                  <div class="receipt-row-qty" id="receipt-item-3">
                    <span>2x</span>
                    <span>Craft Soda</span>
                    <span>$7.98</span>
                  </div>
                </div>
                
                <hr class="receipt-divider">
                
                <!-- Totals -->
                <div class="receipt-line" data-line="subtotal" data-type="total" id="receipt-subtotal" onclick="selectReceiptLine(this)">
                  <div class="receipt-row">
                    <span>Subtotal:</span>
                    <span>$45.95</span>
                  </div>
                </div>
                <div class="receipt-line" data-line="tax" data-type="total" id="receipt-tax-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-row">
                    <span>Tax (8%):</span>
                    <span>$3.68</span>
                  </div>
                </div>
                
                <hr class="receipt-divider receipt-divider-double">
                
                <div class="receipt-line" data-line="grand-total" data-type="total" onclick="selectReceiptLine(this)">
                  <div class="receipt-row receipt-total-row">
                    <span>TOTAL:</span>
                    <span>$49.63</span>
                  </div>
                </div>
                
                <!-- Payment Method -->
                <div class="receipt-line" data-line="payment-method" data-type="info" id="receipt-payment-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-row" style="font-size: 12px; color: #666;">
                    <span>Paid via:</span>
                    <span>Visa  4242</span>
                  </div>
                </div>
                
                <!-- Footer -->
                <div class="receipt-line" data-line="footer-message" data-type="footer" id="receipt-footer-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-footer-text">Thank you for your order!</div>
                </div>
                
                <div class="receipt-line" data-line="barcode" data-type="footer" id="receipt-barcode-line" onclick="selectReceiptLine(this)">
                  <div class="receipt-barcode">*ORD1234*</div>
                </div>
              </div>
              
              <!-- Edit Panel -->
              <div class="receipt-edit-panel" id="receipt-edit-panel">
                <div class="edit-panel-empty" id="edit-panel-empty">
                  <div class="edit-panel-empty-icon"></div>
                  <p>Click on any line in the receipt to edit it</p>
                </div>
                <div id="edit-panel-content" style="display: none;">
                  <div class="edit-panel-title">
                    <span id="edit-line-icon"></span>
                    <span id="edit-line-title">Edit Line</span>
                    <span class="line-type-badge" id="edit-line-type">Header</span>
                  </div>
                  <div id="edit-fields"></div>
                  <div class="edit-actions">
                    <button class="edit-btn apply" onclick="applyLineEdit()">Apply Changes</button>
                    <button class="edit-btn reset" onclick="resetLineEdit()">Reset</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="item-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Add Menu Item</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="item-form">
          <input type="hidden" id="item-id">
          
          <div class="form-group">
            <label class="form-label">Photo</label>
            <div class="photo-upload" id="photo-upload" onclick="document.getElementById('photo-input').click()">
              <div class="photo-upload-icon"></div>
              <p class="photo-upload-text">Click or drag to upload photo</p>
            </div>
            <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhotoSelect(event)">
            <input type="hidden" id="photo-url">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="item-name">Name *</label>
              <input type="text" class="form-input" id="item-name" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="item-price">Price *</label>
              <input type="number" step="0.01" class="form-input" id="item-price" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="item-category">Category</label>
            <select class="form-select" id="item-category">
              <option value="Starters">Starters</option>
              <option value="Bar Snacks">Bar Snacks</option>
              <option value="Buffalo Wings">Buffalo Wings</option>
              <option value="Burgers">Burgers</option>
              <option value="Dawgs">Dawgs</option>
              <option value="Tacos">Tacos</option>
              <option value="From our grill">From Our Grill</option>
              <option value="Plant Powered">Plant Powered</option>
              <option value="Sides">Sides</option>
              <option value="Desserts">Desserts</option>
              <option value="Drinks">Drinks</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="item-description">Description</label>
            <textarea class="form-textarea" id="item-description" placeholder="Describe the dish..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="item-reviews">Reviews Link</label>
            <input type="url" class="form-input" id="item-reviews" placeholder="https://yelp.com/biz/...">
            <p class="form-hint">Link to external reviews for this item</p>
          </div>

          <div class="form-group">
            <label class="form-label">AI Keywords</label>
            <p class="form-hint" style="margin-bottom: 0.75rem">Help the AI match customer requests. Weight 0.0-1.0 (higher = stronger match)</p>
            <div class="keywords-editor" id="keywords-editor">
              <div id="keyword-rows"></div>
              <button type="button" class="add-keyword-btn" onclick="addKeywordRow()">+ Add Keyword</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Dietary Tags</label>
            <p class="form-hint" style="margin-bottom: 0.75rem">Click to toggle tags. These help customers filter the menu.</p>
            <div class="tag-selector" id="dietary-tag-selector">
              <button type="button" class="tag-option" data-tag="vegetarian">Vegetarian</button>
              <button type="button" class="tag-option" data-tag="vegan">Vegan</button>
              <button type="button" class="tag-option" data-tag="gluten-free">Gluten-Free</button>
              <button type="button" class="tag-option" data-tag="dairy-free">Dairy-Free</button>
              <button type="button" class="tag-option" data-tag="spicy">Spicy</button>
              <button type="button" class="tag-option" data-tag="mild">Mild</button>
              <button type="button" class="tag-option" data-tag="keto">Keto</button>
              <button type="button" class="tag-option" data-tag="low-carb">Low-Carb</button>
              <button type="button" class="tag-option" data-tag="halal">Halal</button>
              <button type="button" class="tag-option" data-tag="kosher">Kosher</button>
            </div>
            <div class="custom-tag-add">
              <input type="text" class="form-input" id="custom-dietary-tag" placeholder="Add custom tag...">
              <button type="button" class="btn-add-tag" onclick="addCustomDietaryTag()">+</button>
            </div>
            <div class="selected-tags" id="selected-dietary-tags"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Allergens</label>
            <p class="form-hint" style="margin-bottom: 0.75rem">Click to toggle allergen warnings.</p>
            <div class="tag-selector" id="allergen-tag-selector">
              <button type="button" class="tag-option allergen" data-tag="dairy">Dairy</button>
              <button type="button" class="tag-option allergen" data-tag="gluten">Gluten</button>
              <button type="button" class="tag-option allergen" data-tag="nuts">Nuts</button>
              <button type="button" class="tag-option allergen" data-tag="peanuts">Peanuts</button>
              <button type="button" class="tag-option allergen" data-tag="eggs">Eggs</button>
              <button type="button" class="tag-option allergen" data-tag="soy">Soy</button>
              <button type="button" class="tag-option allergen" data-tag="shellfish">Shellfish</button>
              <button type="button" class="tag-option allergen" data-tag="fish">Fish</button>
              <button type="button" class="tag-option allergen" data-tag="sesame">Sesame</button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-btn" onclick="saveItem()">Save Item</button>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div id="order-modal" class="modal-overlay" onclick="if(event.target === this) closeOrderModal()">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Order Details</h2>
        <button class="modal-close" onclick="closeOrderModal()">&times;</button>
      </div>
      <div class="modal-body" id="order-modal-body">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <div id="scan-modal" class="modal-overlay" onclick="if(event.target===this)closeScanModal()">
    <div class="modal" style="max-width: 560px;">
      <div class="modal-header">
        <h2 class="modal-title"> Scan Menu</h2>
        <button class="modal-close" onclick="closeScanModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">Upload a photo or file of your menu and AI will automatically read it and create all the items for you.</p>
        
        <div id="scan-upload-area" class="scan-upload-area" onclick="document.getElementById('scan-file-input').click()">
          <div id="scan-upload-content">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;"></div>
            <p style="font-weight: 600; color: var(--text);">Click to upload menu image</p>
            <p style="font-size: 0.8rem; color: var(--text-muted);">Supports JPG, PNG, WEBP, PDF</p>
          </div>
          <img id="scan-preview" style="display:none; max-width:100%; max-height:300px; border-radius:8px;" alt="Menu preview">
        </div>
        <input type="file" id="scan-file-input" accept="image/*,.pdf" style="display:none" onchange="handleScanFileSelect(event)">
        
        <div id="scan-progress" style="display:none;">
          <div class="scan-progress-bar">
            <div class="scan-progress-fill" id="scan-progress-fill"></div>
          </div>
          <p id="scan-status" style="text-align:center; margin-top:0.75rem; font-size:0.9rem; color:var(--text-muted);">Uploading...</p>
        </div>
        
        <div id="scan-results" style="display:none;">
          <div id="scan-results-content"></div>
        </div>
        
        <div style="display:flex; gap:0.75rem; margin-top:1.25rem;">
          <button class="add-btn" id="scan-submit-btn" onclick="submitMenuScan()" disabled style="flex:1; justify-content:center;">
            <span></span> Scan & Create Items
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let menuItems = [];
    let editingId = null;
    let currentOrderId = null;
    let activeCategory = 'all';
    let activeDietaryTags = new Set();
    let selectedDietaryTags = new Set();
    let selectedAllergens = new Set();
    let customDietaryTags = [];

    function init() {
      loadMenu();
      setupFilters();
      setupTagSelectors();

      var urlTab = new URLSearchParams(window.location.search).get('tab');
      if (urlTab) {
        var tabBtn = document.querySelector('.tab[data-tab="' + urlTab + '"]');
        if (tabBtn) tabBtn.click();
      }
    }

    function setupTagSelectors() {
      document.querySelectorAll('#dietary-tag-selector .tag-option').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('selected');
          const tag = btn.dataset.tag;
          if (selectedDietaryTags.has(tag)) {
            selectedDietaryTags.delete(tag);
          } else {
            selectedDietaryTags.add(tag);
          }
        });
      });

      document.querySelectorAll('#allergen-tag-selector .tag-option').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('selected');
          const tag = btn.dataset.tag;
          if (selectedAllergens.has(tag)) {
            selectedAllergens.delete(tag);
          } else {
            selectedAllergens.add(tag);
          }
        });
      });
      
      document.getElementById('custom-dietary-tag').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addCustomDietaryTag();
        }
      });
    }

    function addCustomDietaryTag() {
      const input = document.getElementById('custom-dietary-tag');
      const tag = input.value.trim().toLowerCase();
      if (tag && !customDietaryTags.includes(tag) && !selectedDietaryTags.has(tag)) {
        customDietaryTags.push(tag);
        renderCustomTags();
        input.value = '';
      }
    }

    function removeCustomTag(tag) {
      customDietaryTags = customDietaryTags.filter(t => t !== tag);
      renderCustomTags();
    }

    function renderCustomTags() {
      const container = document.getElementById('selected-dietary-tags');
      container.innerHTML = customDietaryTags.map(tag => `
        <span class="custom-tag">
          ${tag}
          <button type="button" class="remove-tag" onclick="removeCustomTag('${tag}')"></button>
        </span>
      `).join('');
    }

    function resetTagSelectors() {
      selectedDietaryTags.clear();
      selectedAllergens.clear();
      customDietaryTags = [];
      
      document.querySelectorAll('#dietary-tag-selector .tag-option').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelectorAll('#allergen-tag-selector .tag-option').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('selected-dietary-tags').innerHTML = '';
    }

    function populateTags(dietaryTags, allergens) {
      resetTagSelectors();
      
      (dietaryTags || []).forEach(tag => {
        const normalizedTag = tag.toLowerCase();
        const btn = document.querySelector(`#dietary-tag-selector .tag-option[data-tag="${normalizedTag}"]`);
        if (btn) {
          btn.classList.add('selected');
          selectedDietaryTags.add(normalizedTag);
        } else {
          customDietaryTags.push(normalizedTag);
        }
      });
      
      (allergens || []).forEach(tag => {
        const normalizedTag = tag.toLowerCase();
        const btn = document.querySelector(`#allergen-tag-selector .tag-option[data-tag="${normalizedTag}"]`);
        if (btn) {
          btn.classList.add('selected');
          selectedAllergens.add(normalizedTag);
        }
      });
      
      renderCustomTags();
    }

    function getSelectedTags() {
      return {
        dietaryTags: [...selectedDietaryTags, ...customDietaryTags],
        allergens: [...selectedAllergens]
      };
    }

    function setupFilters() {
      document.querySelectorAll('#category-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('#category-filters .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          activeCategory = chip.dataset.filter;
          applyFilters();
        });
      });

      document.querySelectorAll('#dietary-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
          const tag = chip.dataset.dietary;
          if (activeDietaryTags.has(tag)) {
            activeDietaryTags.delete(tag);
          } else {
            activeDietaryTags.add(tag);
          }
          applyFilters();
        });
      });
    }

    function applyFilters() {
      const searchTerm = document.getElementById('menu-search').value.toLowerCase();
      
      const filtered = menuItems.filter(item => {
        if (activeCategory !== 'all' && item.category !== activeCategory) {
          return false;
        }
        
        if (activeDietaryTags.size > 0) {
          const itemTags = (item.dietaryTags || []).map(t => t.toLowerCase());
          const itemKeywords = Object.keys(item.weightedKeywords || {}).map(k => k.toLowerCase());
          const allItemTags = [...itemTags, ...itemKeywords];
          
          for (const tag of activeDietaryTags) {
            if (!allItemTags.some(t => t.includes(tag))) {
              return false;
            }
          }
        }
        
        if (searchTerm) {
          const name = (item.name || '').toLowerCase();
          const desc = (item.description || '').toLowerCase();
          const category = (item.category || '').toLowerCase();
          if (!name.includes(searchTerm) && !desc.includes(searchTerm) && !category.includes(searchTerm)) {
            return false;
          }
        }
        
        return true;
      });

      renderFilteredMenu(filtered);
    }

    // ========================
    // KITCHEN DISPLAY (embedded)
    // ========================
    let kdsOrders = [];
    let kdsPrevCount = 0;
    let kdsInterval = null;
    let kdsTimerInterval = null;

    function kdsTimeAgo(dateStr) {
      const diff = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
      if (diff < 60) return diff + 's';
      if (diff < 3600) return Math.floor(diff / 60) + 'm';
      return Math.floor(diff / 3600) + 'h ' + Math.floor((diff % 3600) / 60) + 'm';
    }

    function kdsUrgency(dateStr) {
      const mins = (Date.now() - new Date(dateStr).getTime()) / 60000;
      if (mins > 15) return 'urgent';
      if (mins > 5) return 'warning';
      return 'ok';
    }

    function kdsParseItems(v) {
      try { return typeof v === 'string' ? JSON.parse(v) : (v || []); } catch { return []; }
    }

    function kdsRenderCard(order, actions) {
      const items = kdsParseItems(order.items);
      const urg = kdsUrgency(order.createdAt);
      const ot = order.orderType || 'dine_in';
      return '<div class="kds-order ' + urg + '" data-kid="' + order.id + '">' +
        '<div class="kds-order-head"><div style="display:flex;align-items:center;gap:0.6rem">' +
        '<span class="kds-order-id">#' + order.id + '</span>' +
        (order.tableNumber ? '<span class="kds-order-table">Table ' + order.tableNumber + '</span>' : '') +
        '<span class="kds-order-type ' + ot + '">' + ot.replace('_', ' ') + '</span>' +
        '</div><span class="kds-order-timer ' + (urg === 'ok' ? '' : urg) + '">' + kdsTimeAgo(order.createdAt) + '</span></div>' +
        '<div class="kds-order-items">' + items.map(function(it) {
          return '<div class="kds-order-item"><span class="kds-order-item-qty">' + it.quantity + 'x</span><span class="kds-order-item-name">' + it.name + (it.modifications ? ' (' + it.modifications + ')' : '') + '</span></div>';
        }).join('') + '</div>' +
        (order.specialInstructions ? '<div class="kds-order-note">' + order.specialInstructions + '</div>' : '') +
        '<div class="kds-order-actions">' + actions + '</div></div>';
    }

    function kdsRender() {
      var nw = kdsOrders.filter(function(o) { return o.status === 'pending' || o.status === 'confirmed'; });
      var pr = kdsOrders.filter(function(o) { return o.status === 'preparing'; });
      var rd = kdsOrders.filter(function(o) { return o.status === 'ready'; });

      var el = function(id) { var e = document.getElementById(id); return e; };
      el('kds-new-count').textContent = nw.length;
      el('kds-prep-count').textContent = pr.length;
      el('kds-ready-count').textContent = rd.length;
      el('kds-new-head').textContent = nw.length;
      el('kds-prep-head').textContent = pr.length;
      el('kds-ready-head').textContent = rd.length;

      el('kds-new-orders').innerHTML = nw.length
        ? nw.map(function(o) { return kdsRenderCard(o, '<button class="kds-btn kds-btn-start" onclick="kdsUpdate(' + o.id + ',\'preparing\')">Start Preparing</button>'); }).join('')
        : '<div class="kds-empty">No new orders</div>';

      el('kds-prep-orders').innerHTML = pr.length
        ? pr.map(function(o) { return kdsRenderCard(o, '<button class="kds-btn kds-btn-bump" onclick="kdsUpdate(' + o.id + ',\'pending\')">Bump Back</button><button class="kds-btn kds-btn-ready" onclick="kdsUpdate(' + o.id + ',\'ready\')">Ready!</button>'); }).join('')
        : '<div class="kds-empty">Nothing cooking</div>';

      el('kds-ready-orders').innerHTML = rd.length
        ? rd.map(function(o) { return kdsRenderCard(o, '<button class="kds-btn kds-btn-complete" onclick="kdsUpdate(' + o.id + ',\'completed\')">Complete</button>'); }).join('')
        : '<div class="kds-empty">All served</div>';
    }

    async function kdsFetch() {
      try {
        var res = await fetch('/api/admin/orders');
        if (!res.ok) return;
        var orders = await res.json();
        var active = orders.filter(function(o) { return o.status !== 'completed' && o.status !== 'cancelled' && o.status !== 'refunded'; });
        if (active.length > kdsPrevCount && kdsPrevCount > 0) {
          try { document.getElementById('kds-ding').play(); } catch(e) {}
        }
        kdsPrevCount = active.length;
        kdsOrders = active;
        kdsRender();
      } catch(e) { console.error('KDS fetch error:', e); }
    }

    async function kdsUpdate(id, status) {
      try {
        await fetch('/api/admin/orders/' + id + '/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status }),
        });
        var order = kdsOrders.find(function(o) { return o.id === id; });
        if (order) {
          if (status === 'completed') {
            kdsOrders = kdsOrders.filter(function(o) { return o.id !== id; });
          } else {
            order.status = status;
          }
          kdsRender();
        }
      } catch(e) { console.error('KDS update error:', e); }
    }

    function kdsStart() {
      kdsFetch();
      if (kdsInterval) clearInterval(kdsInterval);
      kdsInterval = setInterval(kdsFetch, 5000);
      function tick() {
        var c = document.getElementById('kds-clock');
        if (c) { var n = new Date(); c.textContent = n.toLocaleTimeString('en-AU', { hour12: false, hour: '2-digit', minute: '2-digit' }); }
      }
      tick();
      if (kdsTimerInterval) clearInterval(kdsTimerInterval);
      kdsTimerInterval = setInterval(tick, 1000);
    }

    function kdsStop() {
      if (kdsInterval) { clearInterval(kdsInterval); kdsInterval = null; }
      if (kdsTimerInterval) { clearInterval(kdsTimerInterval); kdsTimerInterval = null; }
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
        
        if (tab.dataset.tab === 'orders') {
          loadOrders();
        }
        if (tab.dataset.tab === 'kitchen') {
          kdsStart();
        } else {
          kdsStop();
        }
      });
    });

    async function loadMenu() {
      try {
        const res = await fetch('/api/admin/menu', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load menu');
        menuItems = await res.json();
        renderMenu();
      } catch (e) {
        console.error('Error loading menu:', e);
        document.getElementById('menu-grid').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">Failed to load menu</p>
            <p>Please try refreshing the page</p>
          </div>
        `;
      }
    }

    function renderMenu() {
      applyFilters();
    }

    const categoryIcons = {
      'Starters': '',
      'Bar Snacks': '',
      'Buffalo Wings': '',
      'Burgers': '',
      'Dawgs': '',
      'Tacos': '',
      'From our grill': '',
      'Plant Powered': '',
      'Sides': '',
      'Desserts': '',
      'Drinks': '',
      'Uncategorized': ''
    };
    
    const categoryOrder = ['Starters', 'Bar Snacks', 'Buffalo Wings', 'Burgers', 'Dawgs', 'Tacos', 'From our grill', 'Plant Powered', 'Sides', 'Desserts', 'Drinks', 'Uncategorized'];

    let expandedCategories = new Set();

    function toggleCategory(headerEl) {
      const section = headerEl.closest('.category-section');
      const cat = section.getAttribute('data-cat');
      section.classList.toggle('collapsed');
      if (section.classList.contains('collapsed')) {
        expandedCategories.delete(cat);
      } else {
        expandedCategories.add(cat);
      }
    }

    function renderFilteredMenu(items) {
      const grid = document.getElementById('menu-grid');
      const countEl = document.getElementById('item-count');
      
      countEl.textContent = items.length === menuItems.length 
        ? `${items.length} items` 
        : `${items.length} of ${menuItems.length} items`;
      
      if (menuItems.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">No menu items yet</p>
            <p>Add your first item to get started</p>
          </div>
        `;
        return;
      }

      if (items.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">No items match your filters</p>
            <p>Try adjusting your category or dietary filters</p>
          </div>
        `;
        return;
      }

      // Group items by category
      const grouped = {};
      items.forEach(item => {
        const cat = item.category || 'Uncategorized';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });

      // Render grouped by category
      grid.innerHTML = categoryOrder
        .filter(cat => grouped[cat] && grouped[cat].length > 0)
        .map(category => {
          const catItems = grouped[category];
          const catClass = category.toLowerCase().replace(/\s+/g, '-');
          
          const itemsHtml = catItems.map(item => {
            const keywords = item.weightedKeywords || {};
            const dietaryTags = item.dietaryTags || [];
            const keywordTags = Object.entries(keywords).slice(0, 3).map(([k, w]) => 
              `<span class="keyword-tag">${k}<span class="keyword-weight">${w}</span></span>`
            ).join('');
            const dietaryBadges = dietaryTags.slice(0, 2).map(tag => 
              `<span class="dietary-badge">${tag}</span>`
            ).join('');

            return `
              <div class="menu-card" data-category="${item.category || ''}">
                <div class="card-image">
                  ${item.photoUrl 
                    ? `<img src="${item.photoUrl}" alt="${item.name}">`
                    : '<div class="placeholder"></div>'
                  }
                </div>
                <div class="card-content">
                  <div class="card-header">
                    <span class="card-name">${item.name}</span>
                    <span class="card-price">$${parseFloat(item.price).toFixed(2)}</span>
                  </div>
                  <div class="card-tags">
                    ${dietaryBadges}
                  </div>
                  <p class="card-desc">${item.description || 'No description'}</p>
                  ${keywordTags ? `<div class="card-keywords">${keywordTags}</div>` : ''}
                  <div class="card-actions">
                    <button class="card-btn edit" onclick="editItem(${item.id})">Edit</button>
                    <button class="card-btn delete" onclick="deleteItem(${item.id})">Delete</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          const isCollapsed = !expandedCategories.has(category);
          return `
            <div class="category-section${isCollapsed ? ' collapsed' : ''}" data-cat="${category}">
              <div class="category-header" onclick="toggleCategory(this)">
                <div class="category-icon ${catClass}">${categoryIcons[category] || ''}</div>
                <h3 class="category-title">${category}</h3>
                <span class="category-count">${catItems.length} item${catItems.length !== 1 ? 's' : ''}</span>
                <svg class="category-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
              <div class="category-items">
                ${itemsHtml}
              </div>
            </div>
          `;
        }).join('');
    }

    async function loadOrders() {
      try {
        const res = await fetch('/api/admin/orders', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load orders');
        const orders = await res.json();
        renderOrders(orders);
      } catch (e) {
        console.error('Error loading orders:', e);
        document.getElementById('orders-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">Failed to load orders</p>
          </div>
        `;
      }
    }

    function renderOrders(orders) {
      const container = document.getElementById('orders-container');
      
      if (orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">No orders yet</p>
            <p>Orders will appear here when customers place them</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => {
              let items = [];
              try {
                items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []);
              } catch (e) {
                items = [];
              }
              const itemNames = Array.isArray(items) ? items.map(i => i.name).join(', ') : 'N/A';
              const statusClass = `status-${(order.status || 'pending').toLowerCase().replace('_', '-')}`;
              const time = order.createdAt ? new Date(order.createdAt).toLocaleString() : 'N/A';
              return `
                <tr class="order-row" onclick="toggleOrderExpand(${order.id}, this)" style="cursor: pointer;">
                  <td>
                    <span class="expand-arrow" id="arrow-${order.id}"></span>
                    #${order.id}
                  </td>
                  <td>${itemNames || 'N/A'}</td>
                  <td>$${parseFloat(order.total || 0).toFixed(2)}</td>
                  <td><span class="status-badge ${statusClass}">${order.status || 'pending'}</span></td>
                  <td>${time}</td>
                </tr>
                <tr class="order-expand-row" id="expand-${order.id}" style="display: none;">
                  <td colspan="5">
                    <div class="order-expand-content" id="expand-content-${order.id}">
                      <div class="loading"><div class="spinner"></div></div>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Add Menu Item';
      document.getElementById('item-form').reset();
      document.getElementById('item-id').value = '';
      document.getElementById('photo-url').value = '';
      document.getElementById('photo-upload').innerHTML = `
        <div class="photo-upload-icon"></div>
        <p class="photo-upload-text">Click or drag to upload photo</p>
      `;
      document.getElementById('photo-upload').classList.remove('has-image');
      document.getElementById('keyword-rows').innerHTML = '';
      addKeywordRow();
      resetTagSelectors();
      document.getElementById('item-modal').classList.add('active');
    }

    function editItem(id) {
      const item = menuItems.find(m => m.id === id);
      if (!item) return;

      editingId = id;
      document.getElementById('modal-title').textContent = 'Edit Menu Item';
      document.getElementById('item-id').value = id;
      document.getElementById('item-name').value = item.name || '';
      document.getElementById('item-price').value = item.price || '';
      document.getElementById('item-category').value = item.category || 'Mains';
      document.getElementById('item-description').value = item.description || '';
      document.getElementById('item-reviews').value = item.reviewsUrl || '';
      document.getElementById('photo-url').value = item.photoUrl || '';
      
      populateTags(item.dietaryTags, item.allergens);
      
      if (item.photoUrl) {
        document.getElementById('photo-upload').innerHTML = `<img src="${item.photoUrl}" alt="${item.name}">`;
        document.getElementById('photo-upload').classList.add('has-image');
      } else {
        document.getElementById('photo-upload').innerHTML = `
          <div class="photo-upload-icon"></div>
          <p class="photo-upload-text">Click or drag to upload photo</p>
        `;
        document.getElementById('photo-upload').classList.remove('has-image');
      }

      document.getElementById('keyword-rows').innerHTML = '';
      const keywords = item.weightedKeywords || {};
      if (Object.keys(keywords).length === 0) {
        addKeywordRow();
      } else {
        Object.entries(keywords).forEach(([k, w]) => addKeywordRow(k, w));
      }

      document.getElementById('item-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('item-modal').classList.remove('active');
    }

    async function toggleOrderExpand(orderId, rowElement) {
      const expandRow = document.getElementById(`expand-${orderId}`);
      const arrow = document.getElementById(`arrow-${orderId}`);
      const contentDiv = document.getElementById(`expand-content-${orderId}`);
      
      // If already expanded, collapse it
      if (expandRow.style.display === 'table-row') {
        expandRow.style.display = 'none';
        arrow.textContent = '';
        arrow.classList.remove('expanded');
        currentOrderId = null;
        return;
      }
      
      // Collapse any other expanded rows
      document.querySelectorAll('.order-expand-row').forEach(row => {
        row.style.display = 'none';
      });
      document.querySelectorAll('.expand-arrow').forEach(a => {
        a.textContent = '';
        a.classList.remove('expanded');
      });
      
      // Expand this row
      expandRow.style.display = 'table-row';
      arrow.textContent = '';
      arrow.classList.add('expanded');
      currentOrderId = orderId;
      
      // Load order details
      contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const res = await fetch(`/api/admin/orders/${orderId}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load order');
        const order = await res.json();
        renderOrderDetailInline(order, contentDiv);
      } catch (e) {
        console.error('Error loading order:', e);
        contentDiv.innerHTML = `
          <div class="empty-state" style="padding: 20px;">
            <div class="empty-state-icon"></div>
            <p class="empty-state-title">Failed to load order details</p>
          </div>
        `;
      }
    }

    function renderOrderDetailInline(order, container) {
      let items = [];
      try {
        items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []);
      } catch (e) {
        items = [];
      }
      
      const statusClass = `status-${(order.status || 'pending').toLowerCase().replace('_', '-')}`;
      const time = order.createdAt ? new Date(order.createdAt).toLocaleString() : 'N/A';
      const isRefunded = order.status === 'refunded' || order.status === 'partial_refund';
      const hasPayment = !!order.paymentId;
      
      container.innerHTML = `
        <div class="order-expand-detail">
          <div class="order-expand-grid">
            <div class="order-expand-col">
              <h4 class="order-section-title">Customer</h4>
              <div class="order-expand-info">
                <div><strong>${order.customerName || 'Guest'}</strong></div>
                <div>${order.customerEmail || ''}</div>
                <div>${order.customerPhone || ''}</div>
                <div>${order.tableNumber ? (order.tableNumber === 'Pickup' ? ' Pickup' : ' Table ' + order.tableNumber) : ''}</div>
              </div>
            </div>
            
            <div class="order-expand-col">
              <h4 class="order-section-title">Items</h4>
              <div class="order-expand-items">
                ${items.map((item, idx) => `
                  <div class="order-expand-item">
                    <input type="checkbox" class="item-refund-check" data-index="${idx}" ${isRefunded ? 'disabled' : ''}>
                    <span class="item-qty">${item.quantity || 1}x</span>
                    <span class="item-name">${item.name}</span>
                    <span class="item-price">$${(parseFloat(item.price) * (item.quantity || 1)).toFixed(2)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="order-expand-col">
              <h4 class="order-section-title">Payment</h4>
              <div class="order-expand-totals">
                <div class="total-line"><span>Subtotal</span><span>$${parseFloat(order.subtotal || 0).toFixed(2)}</span></div>
                <div class="total-line"><span>Tax</span><span>$${parseFloat(order.tax || 0).toFixed(2)}</span></div>
                <div class="total-line total"><span>Total</span><span>$${parseFloat(order.total || 0).toFixed(2)}</span></div>
                <div class="total-line" style="font-size: 11px; color: #888;"><span>Method</span><span>${order.paymentMethod || 'N/A'}</span></div>
              </div>
            </div>
            
            <div class="order-expand-col">
              <h4 class="order-section-title">Status</h4>
              <div class="order-expand-status">
                <div class="print-status ${order.printedAt ? 'printed' : 'not-printed'}">
                  ${order.printedAt ? ' Printed' : ' Not printed'}
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                  ${time}
                </div>
              </div>
            </div>
          </div>
          
          <div class="order-expand-actions">
            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); reprintOrder(${order.id})">
               Reprint
            </button>
            ${!isRefunded && hasPayment ? `
              <button class="btn btn-small btn-warning" onclick="event.stopPropagation(); partialRefundOrder(${order.id})">
                 Partial Refund
              </button>
              <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); fullRefundOrder(${order.id})">
                 Full Refund
              </button>
            ` : ''}
            ${isRefunded ? `
              <span style="color: #4CAF50; font-size: 12px;"> Refunded</span>
            ` : ''}
          </div>
        </div>
      `;
    }

    async function reprintOrder(orderId) {
      const printerEnabled = document.getElementById('printer-enabled')?.checked;
      if (!printerEnabled) {
        alert('WiFi printing is not enabled. Go to Configuration > WiFi Printing to set it up.');
        return;
      }
      alert('Sending to printer... (Printer integration coming soon)');
    }

    async function fullRefundOrder(orderId) {
      if (!confirm('Are you sure you want to issue a FULL refund for this order? This cannot be undone.')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/refund`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason: 'requested_by_customer' })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Failed to process refund');
        }
        
        alert(`Refund successful! Amount: $${data.amount.toFixed(2)}`);
        openOrderDetail(orderId);
        loadOrders();
      } catch (e) {
        console.error('Refund error:', e);
        alert('Refund failed: ' + e.message);
      }
    }

    async function partialRefundOrder(orderId) {
      const checkboxes = document.querySelectorAll('.item-refund-check:checked');
      
      if (checkboxes.length === 0) {
        alert('Please select at least one item to refund using the checkboxes.');
        return;
      }
      
      const itemIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
      
      if (!confirm(`Refund ${itemIndices.length} selected item(s)? This cannot be undone.`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/orders/${orderId}/partial-refund`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ itemIndices, reason: 'requested_by_customer' })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Failed to process refund');
        }
        
        alert(`Partial refund successful! Amount: $${data.amount.toFixed(2)}`);
        openOrderDetail(orderId);
        loadOrders();
      } catch (e) {
        console.error('Partial refund error:', e);
        alert('Refund failed: ' + e.message);
      }
    }

    function addKeywordRow(keyword = '', weight = 0.5) {
      const row = document.createElement('div');
      row.className = 'keyword-row';
      row.innerHTML = `
        <input type="text" class="keyword-input" value="${keyword}" placeholder="keyword">
        <input type="number" class="keyword-weight-input" value="${weight}" min="0" max="1" step="0.1" placeholder="0.5">
        <button type="button" class="keyword-remove" onclick="this.parentElement.remove()"></button>
      `;
      document.getElementById('keyword-rows').appendChild(row);
    }

    async function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const preview = document.getElementById('photo-upload');
      preview.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';

      try {
        const urlRes = await fetch('/api/admin/upload-url', { 
          method: 'POST',
          credentials: 'include'
        });
        if (!urlRes.ok) throw new Error('Failed to get upload URL');
        const { uploadURL, objectPath } = await urlRes.json();

        const uploadRes = await fetch(uploadURL, {
          method: 'PUT',
          body: file,
          headers: { 'Content-Type': file.type }
        });
        if (!uploadRes.ok) throw new Error('Failed to upload photo');

        const publicUrl = await fetch(`/api/object-storage/url?path=${encodeURIComponent(objectPath)}`);
        const { url } = await publicUrl.json();

        document.getElementById('photo-url').value = url;
        preview.innerHTML = `<img src="${url}" alt="Preview">`;
        preview.classList.add('has-image');
      } catch (e) {
        console.error('Upload error:', e);
        preview.innerHTML = `
          <div class="photo-upload-icon"></div>
          <p class="photo-upload-text">Upload failed. Click to try again.</p>
        `;
        preview.classList.remove('has-image');
      }
    }

    async function saveItem() {
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const keywordRows = document.querySelectorAll('.keyword-row');
        const weightedKeywords = {};
        keywordRows.forEach(row => {
          const keyword = row.querySelector('.keyword-input').value.trim();
          const weight = parseFloat(row.querySelector('.keyword-weight-input').value) || 0.5;
          if (keyword) {
            weightedKeywords[keyword] = Math.min(1, Math.max(0, weight));
          }
        });

        const tags = getSelectedTags();
        
        const data = {
          name: document.getElementById('item-name').value,
          price: parseFloat(document.getElementById('item-price').value),
          category: document.getElementById('item-category').value,
          description: document.getElementById('item-description').value,
          reviewsUrl: document.getElementById('item-reviews').value,
          photoUrl: document.getElementById('photo-url').value,
          weightedKeywords,
          dietaryTags: tags.dietaryTags,
          allergens: tags.allergens
        };

        const url = editingId ? `/api/admin/menu/${editingId}` : '/api/admin/menu';
        const method = editingId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error('Failed to save item');

        closeModal();
        loadMenu();
      } catch (e) {
        console.error('Save error:', e);
        alert('Failed to save item. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Item';
      }
    }

    async function deleteItem(id) {
      if (!confirm('Are you sure you want to delete this item?')) return;

      try {
        const res = await fetch(`/api/admin/menu/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to delete item');
        loadMenu();
      } catch (e) {
        console.error('Delete error:', e);
        alert('Failed to delete item. Please try again.');
      }
    }

    // Configuration management
    function loadConfig() {
      const config = JSON.parse(localStorage.getItem('orderfi_config') || '{}');
      
      // Printer settings
      document.getElementById('printer-enabled').checked = config.printerEnabled || false;
      document.getElementById('printer-ip').value = config.printerIp || '';
      document.getElementById('printer-port').value = config.printerPort || '9100';
      document.getElementById('printer-type').value = config.printerType || 'escpos';
      document.getElementById('printer-width').value = config.printerWidth || '80';
      
      // Receipt settings
      document.getElementById('print-order-number').checked = config.printOrderNumber !== false;
      document.getElementById('print-customer-name').checked = config.printCustomerName !== false;
      document.getElementById('print-prices').checked = config.printPrices !== false;
      document.getElementById('receipt-footer').value = config.receiptFooter || '';
    }

    function saveConfig() {
      const config = {
        printerEnabled: document.getElementById('printer-enabled').checked,
        printerIp: document.getElementById('printer-ip').value,
        printerPort: document.getElementById('printer-port').value,
        printerType: document.getElementById('printer-type').value,
        printerWidth: document.getElementById('printer-width').value,
        printOrderNumber: document.getElementById('print-order-number').checked,
        printCustomerName: document.getElementById('print-customer-name').checked,
        printPrices: document.getElementById('print-prices').checked,
        receiptFooter: document.getElementById('receipt-footer').value
      };
      
      localStorage.setItem('orderfi_config', JSON.stringify(config));
      showStatus('printer-status', 'Settings saved successfully!', 'success');
    }

    function testPrinter() {
      const ip = document.getElementById('printer-ip').value;
      const port = document.getElementById('printer-port').value;
      
      if (!ip) {
        showStatus('printer-status', 'Please enter a printer IP address', 'error');
        return;
      }
      
      showStatus('printer-status', `Testing connection to ${ip}:${port}...`, 'info');
      
      // Simulate connection test (actual implementation would require backend)
      setTimeout(() => {
        showStatus('printer-status', 
          `Connection test complete. Note: Full printer testing requires the printer to be on the same network. Save your settings to enable printing for orders.`, 
          'success'
        );
      }, 1500);
    }

    function showStatus(elementId, message, type) {
      const statusEl = document.getElementById(elementId);
      statusEl.textContent = message;
      statusEl.className = `config-status ${type}`;
      statusEl.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      }
    }

    // WYSIWYG Receipt Preview
    let selectedLine = null;
    let receiptConfig = {
      restaurantName: 'OrderFi Restaurant',
      restaurantAddress: '123 Main Street, City',
      restaurantPhone: '(555) 123-4567',
      footerMessage: 'Thank you for your order!'
    };
    
    const lineTypeLabels = {
      'header': 'Restaurant Name',
      'subheader': 'Address & Phone',
      'info': 'Order Info',
      'item': 'Menu Item',
      'total': 'Totals',
      'footer': 'Footer'
    };
    
    const lineTypeIcons = {
      'header': '',
      'subheader': '',
      'info': '',
      'item': '',
      'total': '',
      'footer': ''
    };
    
    function selectReceiptLine(element) {
      // Remove previous selection
      document.querySelectorAll('.receipt-line.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Select this line
      element.classList.add('selected');
      selectedLine = element;
      
      // Show edit panel
      showEditPanel(element);
    }
    
    function showEditPanel(lineElement) {
      const lineId = lineElement.dataset.line;
      const lineType = lineElement.dataset.type;
      
      document.getElementById('edit-panel-empty').style.display = 'none';
      document.getElementById('edit-panel-content').style.display = 'block';
      
      document.getElementById('edit-line-icon').textContent = lineTypeIcons[lineType] || '';
      document.getElementById('edit-line-title').textContent = lineTypeLabels[lineType] || 'Edit Line';
      document.getElementById('edit-line-type').textContent = lineType.toUpperCase();
      
      const fieldsContainer = document.getElementById('edit-fields');
      
      // Generate edit fields based on line type
      switch (lineId) {
        case 'restaurant-name':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Restaurant Name</div>
              <input type="text" class="edit-field-input" id="edit-restaurant-name" value="${receiptConfig.restaurantName}">
            </div>
          `;
          break;
          
        case 'restaurant-address':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Street Address</div>
              <input type="text" class="edit-field-input" id="edit-address" value="${receiptConfig.restaurantAddress}">
            </div>
            <div class="edit-field-group">
              <div class="edit-field-label">Phone Number</div>
              <input type="text" class="edit-field-input" id="edit-phone" value="${receiptConfig.restaurantPhone}">
            </div>
          `;
          break;
          
        case 'order-number':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Order Number Format</div>
              <input type="text" class="edit-field-input" id="edit-order-format" value="ORD-{number}" disabled>
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Auto-generated for each order</p>
            </div>
            <div class="edit-field-group" style="margin-top: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="edit-show-order" ${document.getElementById('print-order-number').checked ? 'checked' : ''}>
                <span>Show on receipt</span>
              </label>
            </div>
          `;
          break;
          
        case 'customer-name':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Customer Name Display</div>
              <select class="edit-field-input" id="edit-name-format">
                <option value="full">Full Name (John Doe)</option>
                <option value="first-last" selected>First + Last Initial (John D.)</option>
                <option value="first">First Name Only (John)</option>
              </select>
            </div>
            <div class="edit-field-group" style="margin-top: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="edit-show-customer" ${document.getElementById('print-customer-name').checked ? 'checked' : ''}>
                <span>Show on receipt</span>
              </label>
            </div>
          `;
          break;
          
        case 'timestamp':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Date/Time Format</div>
              <select class="edit-field-input" id="edit-time-format">
                <option value="full" selected>Full (Jan 28, 2026 12:34 PM)</option>
                <option value="date">Date Only (Jan 28, 2026)</option>
                <option value="time">Time Only (12:34 PM)</option>
                <option value="short">Short (1/28/26 12:34)</option>
              </select>
            </div>
          `;
          break;
          
        case 'item-1':
        case 'item-2':
        case 'item-3':
          const itemNum = lineId.split('-')[1];
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Sample Item ${itemNum} (for preview)</div>
              <input type="text" class="edit-field-input" id="edit-item-name" value="${lineElement.querySelector('span:nth-child(2)').textContent}">
            </div>
            <div class="edit-field-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="edit-show-prices" ${document.getElementById('print-prices').checked ? 'checked' : ''}>
                <span>Show item prices</span>
              </label>
            </div>
          `;
          break;
          
        case 'subtotal':
        case 'tax':
        case 'grand-total':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Total Line</div>
              <p style="font-size: 0.85rem; color: var(--text);">This line is calculated automatically from order items.</p>
            </div>
            <div class="edit-field-group" style="margin-top: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="edit-show-totals" checked disabled>
                <span>Always shown</span>
              </label>
            </div>
          `;
          break;
          
        case 'footer-message':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Footer Message</div>
              <textarea class="edit-field-input" id="edit-footer-msg" rows="2" style="min-height: 60px;">${receiptConfig.footerMessage}</textarea>
            </div>
          `;
          break;
          
        case 'barcode':
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <div class="edit-field-label">Barcode</div>
              <p style="font-size: 0.85rem; color: var(--text);">Encodes the order number for easy scanning.</p>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.5rem;">
                <input type="checkbox" id="edit-show-barcode" checked>
                <span>Show barcode</span>
              </label>
            </div>
          `;
          break;
          
        default:
          fieldsContainer.innerHTML = `
            <div class="edit-field-group">
              <p style="color: var(--text-muted);">This line cannot be customized.</p>
            </div>
          `;
      }
    }
    
    function applyLineEdit() {
      if (!selectedLine) return;
      
      const lineId = selectedLine.dataset.line;
      
      switch (lineId) {
        case 'restaurant-name':
          const newName = document.getElementById('edit-restaurant-name').value;
          receiptConfig.restaurantName = newName;
          selectedLine.querySelector('.receipt-header').textContent = newName;
          break;
          
        case 'restaurant-address':
          const newAddress = document.getElementById('edit-address').value;
          const newPhone = document.getElementById('edit-phone').value;
          receiptConfig.restaurantAddress = newAddress;
          receiptConfig.restaurantPhone = newPhone;
          selectedLine.querySelector('.receipt-subheader').innerHTML = `${newAddress}<br>Tel: ${newPhone}`;
          break;
          
        case 'order-number':
          const showOrder = document.getElementById('edit-show-order').checked;
          document.getElementById('print-order-number').checked = showOrder;
          updateReceiptVisibility();
          break;
          
        case 'customer-name':
          const showCustomer = document.getElementById('edit-show-customer').checked;
          document.getElementById('print-customer-name').checked = showCustomer;
          updateReceiptVisibility();
          break;
          
        case 'item-1':
        case 'item-2':
        case 'item-3':
          const showPrices = document.getElementById('edit-show-prices').checked;
          document.getElementById('print-prices').checked = showPrices;
          updateReceiptVisibility();
          break;
          
        case 'footer-message':
          const newFooter = document.getElementById('edit-footer-msg').value;
          receiptConfig.footerMessage = newFooter;
          selectedLine.querySelector('.receipt-footer-text').textContent = newFooter;
          document.getElementById('receipt-footer').value = newFooter;
          break;
          
        case 'barcode':
          const showBarcode = document.getElementById('edit-show-barcode').checked;
          selectedLine.style.display = showBarcode ? 'block' : 'none';
          break;
      }
      
      // Save receipt config to localStorage
      saveReceiptConfig();
      
      // Flash effect to confirm
      selectedLine.style.background = 'rgba(76, 175, 80, 0.2)';
      setTimeout(() => {
        selectedLine.style.background = '';
      }, 300);
    }
    
    function resetLineEdit() {
      if (selectedLine) {
        showEditPanel(selectedLine);
      }
    }
    
    // Current receipt type being edited
    let currentReceiptType = 'kitchen';
    
    function switchReceiptType(type) {
      currentReceiptType = type;
      
      // Update tab buttons
      document.querySelectorAll('.receipt-type-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
      });
      
      // Update settings panels
      document.getElementById('kitchen-settings').style.display = type === 'kitchen' ? 'block' : 'none';
      document.getElementById('tax-settings').style.display = type === 'tax' ? 'block' : 'none';
      
      // Update receipt previews
      document.getElementById('receipt-paper-kitchen').style.display = type === 'kitchen' ? 'block' : 'none';
      document.getElementById('receipt-paper-tax').style.display = type === 'tax' ? 'block' : 'none';
      
      // Clear any selected line
      if (selectedLine) {
        selectedLine.classList.remove('selected');
        selectedLine = null;
      }
      document.getElementById('edit-panel-content').style.display = 'none';
      document.getElementById('edit-panel-empty').style.display = 'block';
      
      // Update visibility based on new type
      updateReceiptVisibility();
    }
    
    function updateReceiptVisibility() {
      // Kitchen receipt visibility
      const showKitchenOrder = document.getElementById('kitchen-order-number')?.checked ?? true;
      const showKitchenTable = document.getElementById('kitchen-table-number')?.checked ?? true;
      const showKitchenQuantities = document.getElementById('kitchen-quantities')?.checked ?? true;
      const showKitchenInstructions = document.getElementById('kitchen-instructions')?.checked ?? true;
      const showKitchenTime = document.getElementById('kitchen-time')?.checked ?? true;
      
      // Kitchen visibility toggles
      const kitchenOrderLine = document.getElementById('kitchen-order-line');
      const kitchenTableLine = document.getElementById('kitchen-table-line');
      const kitchenTimeLine = document.getElementById('kitchen-time-line');
      
      if (kitchenOrderLine) kitchenOrderLine.classList.toggle('dimmed', !showKitchenOrder);
      if (kitchenTableLine) kitchenTableLine.classList.toggle('dimmed', !showKitchenTable);
      if (kitchenTimeLine) kitchenTimeLine.classList.toggle('dimmed', !showKitchenTime);
      
      // Kitchen items quantity styling
      document.querySelectorAll('#receipt-paper-kitchen .receipt-line[data-type="item"]').forEach(item => {
        const qtySpan = item.querySelector('span[style*="font-size: 20px"]');
        if (qtySpan) qtySpan.classList.toggle('dimmed', !showKitchenQuantities);
      });
      
      // Kitchen instructions visibility
      document.querySelectorAll('.kitchen-instructions').forEach(el => {
        el.classList.toggle('dimmed', !showKitchenInstructions);
      });
      
      // Tax receipt visibility
      const showOrderNumber = document.getElementById('print-order-number')?.checked ?? true;
      const showCustomerName = document.getElementById('print-customer-name')?.checked ?? true;
      const showPrices = document.getElementById('print-prices')?.checked ?? true;
      const showTax = document.getElementById('print-tax')?.checked ?? true;
      const showPayment = document.getElementById('print-payment')?.checked ?? true;
      const showBarcode = document.getElementById('print-barcode')?.checked ?? true;
      
      const orderNumberLine = document.getElementById('receipt-order-number');
      const customerNameLine = document.getElementById('receipt-customer-name');
      const taxLine = document.getElementById('receipt-tax-line');
      const paymentLine = document.getElementById('receipt-payment-line');
      const barcodeLine = document.getElementById('receipt-barcode-line');
      
      if (orderNumberLine) orderNumberLine.classList.toggle('dimmed', !showOrderNumber);
      if (customerNameLine) customerNameLine.classList.toggle('dimmed', !showCustomerName);
      if (taxLine) taxLine.classList.toggle('dimmed', !showTax);
      if (paymentLine) paymentLine.classList.toggle('dimmed', !showPayment);
      if (barcodeLine) barcodeLine.classList.toggle('dimmed', !showBarcode);
      
      // Update price visibility on items
      document.querySelectorAll('.receipt-row-qty span:nth-child(3)').forEach(priceEl => {
        if (showPrices) {
          priceEl.classList.remove('price-dimmed');
        } else {
          priceEl.classList.add('price-dimmed');
        }
      });
    }
    
    function updateReceiptPreview() {
      const footerEl = document.getElementById('receipt-footer');
      const footerMessage = footerEl ? footerEl.value : '';
      receiptConfig.footerMessage = footerMessage || 'Thank you for your order!';
      
      const footerLine = document.getElementById('receipt-footer-line');
      if (footerLine) {
        const footerText = footerLine.querySelector('.receipt-footer-text');
        if (footerText) footerText.textContent = receiptConfig.footerMessage;
      }
      
      const printerWidth = document.getElementById('printer-width');
      const paperWidth = printerWidth ? printerWidth.value : '80';
      const receiptPaper = document.getElementById('receipt-paper');
      if (receiptPaper) {
        if (paperWidth === '58') {
          receiptPaper.classList.add('width-58');
        } else {
          receiptPaper.classList.remove('width-58');
        }
      }
      
      updateReceiptVisibility();
    }
    
    function saveReceiptConfig() {
      const config = JSON.parse(localStorage.getItem('orderfi_config') || '{}');
      config.receiptConfig = receiptConfig;
      localStorage.setItem('orderfi_config', JSON.stringify(config));
    }
    
    function loadReceiptConfig() {
      const config = JSON.parse(localStorage.getItem('orderfi_config') || '{}');
      if (config.receiptConfig) {
        receiptConfig = { ...receiptConfig, ...config.receiptConfig };
        
        // Apply loaded config to receipt preview
        const nameEl = document.querySelector('[data-line="restaurant-name"] .receipt-header');
        if (nameEl) nameEl.textContent = receiptConfig.restaurantName;
        
        const addrEl = document.querySelector('[data-line="restaurant-address"] .receipt-subheader');
        if (addrEl) addrEl.innerHTML = `${receiptConfig.restaurantAddress}<br>Tel: ${receiptConfig.restaurantPhone}`;
        
        const footerEl = document.querySelector('[data-line="footer-message"] .receipt-footer-text');
        if (footerEl) footerEl.textContent = receiptConfig.footerMessage;
      }
      
      updateReceiptPreview();
    }
    
    // Add event listeners for config toggles to update preview
    document.getElementById('print-order-number')?.addEventListener('change', updateReceiptVisibility);
    document.getElementById('print-customer-name')?.addEventListener('change', updateReceiptVisibility);
    document.getElementById('print-prices')?.addEventListener('change', updateReceiptVisibility);
    document.getElementById('printer-width')?.addEventListener('change', updateReceiptPreview);

    // Extend the original init to also load config and receipt settings
    const _originalInit = init;
    init = function() {
      _originalInit();
      loadOrders();
      loadConfig();
      loadReceiptConfig();
    };

    // === AI Menu Scanner ===
    let scanImageData = null;
    
    function openScanModal() {
      document.getElementById('scan-modal').classList.add('active');
      resetScanModal();
    }
    
    function closeScanModal() {
      document.getElementById('scan-modal').classList.remove('active');
      resetScanModal();
    }
    
    function resetScanModal() {
      scanImageData = null;
      document.getElementById('scan-preview').style.display = 'none';
      document.getElementById('scan-upload-content').style.display = '';
      document.getElementById('scan-upload-area').classList.remove('has-image');
      document.getElementById('scan-progress').style.display = 'none';
      document.getElementById('scan-results').style.display = 'none';
      document.getElementById('scan-submit-btn').disabled = true;
      document.getElementById('scan-file-input').value = '';
    }
    
    function handleScanFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        scanImageData = e.target.result;
        const preview = document.getElementById('scan-preview');
        preview.src = scanImageData;
        preview.style.display = 'block';
        document.getElementById('scan-upload-content').style.display = 'none';
        document.getElementById('scan-upload-area').classList.add('has-image');
        document.getElementById('scan-submit-btn').disabled = false;
      };
      reader.readAsDataURL(file);
    }
    
    async function submitMenuScan() {
      if (!scanImageData) return;
      
      const submitBtn = document.getElementById('scan-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span></span> Scanning...';
      
      const progress = document.getElementById('scan-progress');
      const progressFill = document.getElementById('scan-progress-fill');
      const status = document.getElementById('scan-status');
      progress.style.display = 'block';
      
      progressFill.style.width = '15%';
      status.textContent = 'Uploading image...';
      
      setTimeout(() => {
        progressFill.style.width = '40%';
        status.textContent = 'AI is reading your menu...';
      }, 1000);
      
      setTimeout(() => {
        progressFill.style.width = '70%';
        status.textContent = 'Extracting menu items...';
      }, 3000);
      
      try {
        const response = await fetch('/api/admin/scan-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: scanImageData }),
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to scan menu');
        }
        
        progressFill.style.width = '100%';
        status.textContent = 'Done!';
        
        const resultsDiv = document.getElementById('scan-results');
        const resultsContent = document.getElementById('scan-results-content');
        
        resultsContent.innerHTML = `
          <div style="text-align:center; margin: 1rem 0;">
            <div style="font-size:2.5rem; margin-bottom:0.5rem;"></div>
            <p style="font-weight:700; font-size:1.1rem; color:var(--text);">${data.totalCreated} items created!</p>
            <p style="font-size:0.85rem; color:var(--text-muted);">${data.totalDetected} items detected from your menu</p>
          </div>
          <div style="max-height:200px; overflow-y:auto; margin-top:0.75rem;">
            ${data.items.map(item => `
              <div class="scan-result-item">
                <span><strong>${item.name}</strong>  $${parseFloat(item.price).toFixed(2)}</span>
                <span class="item-cat">${item.category}</span>
              </div>
            `).join('')}
          </div>
        `;
        resultsDiv.style.display = 'block';
        
        submitBtn.innerHTML = '<span></span> Done!';
        submitBtn.onclick = function() { closeScanModal(); loadMenu(); };
        submitBtn.disabled = false;
        
      } catch (error) {
        progressFill.style.width = '0%';
        status.textContent = 'Error: ' + error.message;
        status.style.color = 'var(--primary)';
        submitBtn.innerHTML = '<span></span> Try Again';
        submitBtn.disabled = false;
        submitBtn.onclick = submitMenuScan;
      }
    }

    init();

  </script>

  <!-- Ghost Guide Overlay -->
  <div class="ghost-overlay" id="ghost-overlay">
    <div class="ghost-backdrop" id="ghost-backdrop"></div>
    <div class="ghost-spotlight" id="ghost-spotlight"></div>
    <div class="ghost-tooltip" id="ghost-tooltip">
      <div class="ghost-tooltip-step" id="ghost-step-label"></div>
      <div class="ghost-tooltip-title" id="ghost-title"></div>
      <div class="ghost-tooltip-body" id="ghost-body"></div>
      <div class="ghost-tooltip-nav">
        <button class="ghost-btn ghost-btn-skip" id="ghost-skip-btn">Skip Tour</button>
        <div class="ghost-tooltip-dots" id="ghost-dots"></div>
        <div style="display:flex; gap:6px;">
          <button class="ghost-btn ghost-btn-back" id="ghost-back-btn">Back</button>
          <button class="ghost-btn ghost-btn-next" id="ghost-next-btn">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    var ghostSteps = [
      {
        target: '.tabs',
        title: 'Navigation Tabs',
        body: 'Switch between your main sections here. Menu Items shows your food catalog, Orders shows incoming orders, and Configuration lets you customize receipts and settings.',
        position: 'bottom'
      },
      {
        target: '.add-btn[onclick="openAddModal()"]',
        title: 'Add Menu Item',
        body: 'Click here to manually add a new dish to your menu. You can set the name, price, category, photo, dietary tags, and AI keywords for voice ordering.',
        position: 'bottom'
      },
      {
        target: '.scan-btn',
        title: 'AI Menu Scanner',
        body: 'Got a printed menu? Take a photo and our AI will automatically read it and import all the items for you. Saves hours of manual entry!',
        position: 'bottom'
      },
      {
        target: '.filter-bar',
        title: 'Filter & Search',
        body: 'Quickly find items by category, dietary tags, or search by name. Useful when you have a large menu and need to update a specific item.',
        position: 'bottom'
      },
      {
        target: '#menu-grid',
        title: 'Your Menu Grid',
        body: 'All your menu items appear here as cards. Click any card to edit it, update prices, change photos, or tweak the AI keywords for better voice recognition.',
        position: 'top'
      },
      {
        target: '[data-tab="orders"]',
        title: 'Recent Orders',
        body: 'Check this tab to see incoming orders. Click any order to view details, and you can process refunds right from here.',
        position: 'bottom',
        beforeShow: function() {}
      },
      {
        target: '[data-tab="config"]',
        title: 'Configuration',
        body: 'Set up your receipt layout here. Choose between kitchen receipts (for your cooks) and customer receipts (with taxes). Click any line to customize it.',
        position: 'bottom',
        beforeShow: function() {}
      },
      {
        target: '#copilot-fab',
        title: 'AI Copilot',
        body: 'Stuck on anything? Click this button to chat with your AI assistant. It knows everything about the dashboard and can walk you through any task.',
        position: 'left'
      }
    ];

    var ghostCurrentStep = 0;
    var ghostActive = false;

    function startGhostGuide() {
      ghostCurrentStep = 0;
      ghostActive = true;
      document.getElementById('ghost-overlay').classList.add('active');
      showGhostStep(0);
    }

    function endGhostGuide() {
      ghostActive = false;
      document.getElementById('ghost-overlay').classList.remove('active');
      document.getElementById('ghost-tooltip').classList.remove('visible');
    }

    function showGhostStep(index) {
      var step = ghostSteps[index];
      if (!step) { endGhostGuide(); return; }

      if (step.beforeShow) step.beforeShow();

      var el = document.querySelector(step.target);
      if (!el) { ghostCurrentStep++; showGhostStep(ghostCurrentStep); return; }

      el.scrollIntoView({ behavior: 'smooth', block: 'center' });

      setTimeout(function() {
        var rect = el.getBoundingClientRect();
        var pad = 10;

        var spotlight = document.getElementById('ghost-spotlight');
        spotlight.style.top = (rect.top - pad) + 'px';
        spotlight.style.left = (rect.left - pad) + 'px';
        spotlight.style.width = (rect.width + pad * 2) + 'px';
        spotlight.style.height = (rect.height + pad * 2) + 'px';

        document.getElementById('ghost-step-label').textContent = 'Step ' + (index + 1) + ' of ' + ghostSteps.length;
        document.getElementById('ghost-title').textContent = step.title;
        document.getElementById('ghost-body').textContent = step.body;

        var dotsHtml = '';
        for (var i = 0; i < ghostSteps.length; i++) {
          var cls = 'ghost-dot';
          if (i < index) cls += ' done';
          if (i === index) cls += ' active';
          dotsHtml += '<div class="' + cls + '"></div>';
        }
        document.getElementById('ghost-dots').innerHTML = dotsHtml;

        document.getElementById('ghost-back-btn').style.display = index === 0 ? 'none' : '';
        var nextBtn = document.getElementById('ghost-next-btn');
        nextBtn.textContent = index === ghostSteps.length - 1 ? 'Finish' : 'Next';

        var tooltip = document.getElementById('ghost-tooltip');
        tooltip.classList.remove('visible');

        var tooltipTop, tooltipLeft;
        var tooltipWidth = 340;
        var gap = 16;

        if (step.position === 'bottom') {
          tooltipTop = rect.bottom + pad + gap;
          tooltipLeft = rect.left + rect.width / 2 - tooltipWidth / 2;
        } else if (step.position === 'top') {
          tooltipTop = rect.top - pad - gap - 200;
          tooltipLeft = rect.left + rect.width / 2 - tooltipWidth / 2;
        } else if (step.position === 'left') {
          tooltipTop = rect.top + rect.height / 2 - 100;
          tooltipLeft = rect.left - pad - gap - tooltipWidth;
        } else {
          tooltipTop = rect.top + rect.height / 2 - 100;
          tooltipLeft = rect.right + pad + gap;
        }

        tooltipLeft = Math.max(16, Math.min(tooltipLeft, window.innerWidth - tooltipWidth - 16));
        tooltipTop = Math.max(16, Math.min(tooltipTop, window.innerHeight - 240));

        tooltip.style.top = tooltipTop + 'px';
        tooltip.style.left = tooltipLeft + 'px';

        setTimeout(function() { tooltip.classList.add('visible'); }, 50);
      }, 350);
    }

    window.startGhostGuide = startGhostGuide;

    document.getElementById('ghost-next-btn').addEventListener('click', function() {
      if (ghostCurrentStep >= ghostSteps.length - 1) {
        endGhostGuide();
      } else {
        ghostCurrentStep++;
        showGhostStep(ghostCurrentStep);
      }
    });

    document.getElementById('ghost-back-btn').addEventListener('click', function() {
      if (ghostCurrentStep > 0) {
        ghostCurrentStep--;
        showGhostStep(ghostCurrentStep);
      }
    });

    document.getElementById('ghost-skip-btn').addEventListener('click', function() {
      endGhostGuide();
    });

    document.getElementById('ghost-backdrop').addEventListener('click', function() {
      endGhostGuide();
    });

    document.addEventListener('keydown', function(e) {
      if (!ghostActive) return;
      if (e.key === 'Escape') endGhostGuide();
      if (e.key === 'ArrowRight') {
        if (ghostCurrentStep >= ghostSteps.length - 1) { endGhostGuide(); }
        else { ghostCurrentStep++; showGhostStep(ghostCurrentStep); }
      }
      if (e.key === 'ArrowLeft' && ghostCurrentStep > 0) { ghostCurrentStep--; showGhostStep(ghostCurrentStep); }
    });

    window.addEventListener('resize', function() {
      if (ghostActive) showGhostStep(ghostCurrentStep);
    });
  })();
  </script>

  <!-- AI Copilot Widget -->
  <button class="copilot-fab" id="copilot-fab" title="AI Copilot" aria-label="Open AI Copilot">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
    </svg>
    <span class="fab-close">&#x2715;</span>
    <span class="copilot-badge" id="copilot-badge"></span>
  </button>

  <div class="copilot-panel" id="copilot-panel" role="dialog" aria-label="AI Copilot Chat">
    <div class="copilot-header">
      <div class="copilot-header-icon"></div>
      <div class="copilot-header-text">
        <h3>OrderFi Copilot</h3>
        <p>Your AI assistant for everything OrderFi</p>
      </div>
    </div>
    
    <div class="copilot-messages" id="copilot-messages">
      <div class="copilot-msg assistant">
        <div class="msg-label">OrderFi Copilot</div>
        Hey there! I'm your OrderFi Copilot. I can help you with anything on this dashboard - managing your menu, understanding orders, setting up receipts, or anything else. What can I help you with?
      </div>
    </div>

    <div class="copilot-quick-actions" id="copilot-quick-actions">
      <button class="copilot-quick-btn" data-quick="How do I add a new menu item?">Add menu item</button>
      <button class="copilot-quick-btn" data-quick="How do I process a refund?">Process refund</button>
      <button class="copilot-quick-btn" data-quick="How does the AI Menu Scanner work?">Menu Scanner</button>
      <button class="copilot-quick-btn" data-quick="How do I set up receipt printing?">Receipt setup</button>
      <button class="copilot-quick-btn" id="copilot-tour-btn" style="background:linear-gradient(135deg,#FF6B35,#FFB347);color:white;border-color:transparent;">Take a Tour</button>
    </div>

    <div class="copilot-typing" id="copilot-typing">
      <div class="copilot-typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div class="copilot-input-area">
      <input type="text" class="copilot-input" id="copilot-input" placeholder="Ask me anything..." maxlength="2000" autocomplete="off" aria-label="Type your message">
      <button class="copilot-send-btn" id="copilot-send-btn" aria-label="Send message">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    (function() {
      let copilotOpen = false;
      let copilotHistory = [];

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function toggleCopilot() {
        copilotOpen = !copilotOpen;
        document.getElementById('copilot-panel').classList.toggle('open', copilotOpen);
        document.getElementById('copilot-fab').classList.toggle('open', copilotOpen);
        if (copilotOpen) {
          setTimeout(function() { document.getElementById('copilot-input').focus(); }, 100);
          document.getElementById('copilot-badge').style.display = 'none';
        }
      }

      function getCurrentPageContext() {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) return activeTab.textContent.trim() + ' tab';
        return 'Dashboard';
      }

      function addCopilotMessage(role, content, feedbackType) {
        const container = document.getElementById('copilot-messages');
        const div = document.createElement('div');
        div.className = 'copilot-msg ' + role;

        if (role === 'assistant') {
          const label = document.createElement('div');
          label.className = 'msg-label';
          label.textContent = 'OrderFi Copilot';
          div.appendChild(label);

          const text = document.createElement('span');
          text.textContent = content;
          div.appendChild(text);

          if (feedbackType && feedbackType !== 'general') {
            const labels = { bug: 'Bug Report Logged', confusion: 'Help Request Logged', feature_request: 'Suggestion Noted', praise: 'Thanks Received' };
            const tag = document.createElement('div');
            tag.className = 'copilot-feedback-tag ' + feedbackType;
            tag.textContent = labels[feedbackType] || feedbackType;
            div.appendChild(tag);
          }
        } else {
          div.textContent = content;
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      async function sendCopilotMessage(overrideText) {
        const input = document.getElementById('copilot-input');
        const message = overrideText || input.value.trim();
        if (!message) return;

        input.value = '';
        addCopilotMessage('user', message);

        const quickActions = document.getElementById('copilot-quick-actions');
        if (quickActions) quickActions.style.display = 'none';

        const typing = document.getElementById('copilot-typing');
        typing.classList.add('visible');

        const sendBtn = document.getElementById('copilot-send-btn');
        sendBtn.disabled = true;

        const messagesContainer = document.getElementById('copilot-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        try {
          const response = await fetch('/api/admin/copilot/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: message,
              conversationHistory: copilotHistory,
              pageContext: getCurrentPageContext(),
            }),
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Failed to get response');

          copilotHistory.push({ role: 'user', content: message });
          copilotHistory.push({ role: 'assistant', content: data.reply });
          if (copilotHistory.length > 20) copilotHistory = copilotHistory.slice(-20);

          typing.classList.remove('visible');
          addCopilotMessage('assistant', data.reply, data.feedbackType);
        } catch (error) {
          typing.classList.remove('visible');
          addCopilotMessage('assistant', "Sorry, I'm having trouble connecting right now. Please try again in a moment.");
        }

        sendBtn.disabled = false;
      }

      document.getElementById('copilot-fab').addEventListener('click', toggleCopilot);
      document.getElementById('copilot-send-btn').addEventListener('click', function() { sendCopilotMessage(); });
      document.getElementById('copilot-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendCopilotMessage();
        }
      });

      document.querySelectorAll('.copilot-quick-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          if (this.id === 'copilot-tour-btn') {
            if (copilotOpen) toggleCopilot();
            setTimeout(function() { startGhostGuide(); }, 300);
            return;
          }
          sendCopilotMessage(this.getAttribute('data-quick'));
        });
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && copilotOpen) {
          toggleCopilot();
        }
      });
    })();
  </script>
</body>
</html>
