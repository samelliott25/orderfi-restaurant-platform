<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Order - OrderFi</title>
  <meta name="description" content="Order food with your voice. Fast, easy, and delicious.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg: #FFF9F5;
      --card: #FFFFFF;
      --text: #2D2A26;
      --text-muted: #6B6560;
      --primary: #E23D28;
      --primary-dark: #C4311F;
      --accent: #FF6B35;
      --fresh: #4CAF50;
      --warm: #FFB347;
      --border: rgba(0,0,0,0.08);
      --accent-glow: rgba(226, 61, 40, 0.4);
      --accent-soft: rgba(226, 61, 40, 0.15);
      --success: #4CAF50;
      --success-glow: rgba(76, 175, 80, 0.3);
      --error: #E23D28;
      /* Legacy color mappings for contrast */
      --olive: #2D2A26;
      --olive-dark: #1A1816;
      --orange: #E23D28;
      --charcoal: #2D2A26;
    }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }
    
    body.focus-mode {
      --accent: var(--olive);
      --accent-glow: rgba(139, 149, 109, 0.2);
      --accent-soft: rgba(139, 149, 109, 0.1);
    }
    
    body.focus-mode .glow-bg,
    body.focus-mode .particle {
      display: none;
    }
    
    .glow-bg {
      position: fixed;
      top: -50%;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: rgba(232, 112, 63, 0.15);
      filter: blur(150px);
      pointer-events: none;
      opacity: 0.5;
      z-index: 0;
    }
    
    header {
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--olive);
      border-bottom: none;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s;
    }
    
    .back-btn:hover {
      color: white;
    }
    
    .back-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .header-logo {
      font-family: 'Lilita One', cursive;
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      background: none;
      -webkit-text-fill-color: white;
    }
    .top-nav { display: flex; gap: 1rem; align-items: center; }
    .top-nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; }
    .top-nav a:hover, .top-nav a.active { color: white; }
    
    .focus-toggle {
      padding: 0.375rem 0.625rem;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 1.5rem;
      color: white;
      font-size: 0.6875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .focus-toggle:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.4);
    }
    
    .focus-toggle svg {
      width: 12px;
      height: 12px;
    }
    
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      width: 100%;
      position: relative;
      z-index: 1;
    }
    
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
      min-height: 200px;
      max-height: 45vh;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .message {
      margin-bottom: 0.75rem;
      padding: 1rem 1.25rem;
      border-radius: 1.25rem;
      max-width: 85%;
      animation: msgIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      line-height: 1.5;
      font-size: 0.9375rem;
    }
    
    @keyframes msgIn {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .message.user {
      background: var(--orange);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.375rem;
    }
    
    .message.assistant {
      background: white;
      color: var(--charcoal);
      border: 1px solid rgba(0,0,0,0.08);
      border-bottom-left-radius: 0.375rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .typing {
      display: flex;
      gap: 5px;
      padding: 1rem 1.25rem;
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 1.25rem;
      border-bottom-left-radius: 0.375rem;
      max-width: 80px;
      animation: msgIn 0.3s ease-out;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--olive);
      border-radius: 50%;
      animation: typePulse 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes typePulse {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-5px); opacity: 1; }
    }
    
    .order-panel {
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 1.25rem;
      padding: 1.25rem;
      margin: 1rem 0;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    
    .order-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    .order-header svg {
      width: 18px;
      height: 18px;
      color: var(--orange);
    }
    
    .order-header h2 {
      font-family: 'Lilita One', cursive;
      font-size: 1rem;
      font-weight: 600;
      color: var(--charcoal);
    }
    
    .order-empty {
      color: var(--muted);
      font-size: 0.875rem;
      text-align: center;
      padding: 1rem 0;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 0.9375rem;
      gap: 0.5rem;
    }
    
    .order-item-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
    }
    
    .order-item-name {
      color: var(--charcoal);
    }
    
    .order-item-price {
      color: var(--olive-dark);
      font-weight: 500;
    }
    
    .order-item-remove {
      background: none;
      border: none;
      color: var(--coral);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.1rem;
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .order-item-remove:hover {
      opacity: 1;
    }
    
    .order-divider {
      height: 1px;
      background: rgba(0,0,0,0.08);
      margin: 0.75rem 0;
    }
    
    .order-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      font-size: 0.875rem;
      color: var(--muted);
    }
    
    .order-row.total {
      font-size: 1rem;
      font-weight: 700;
      color: var(--charcoal);
      padding-top: 0.5rem;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-top: 0.5rem;
    }
    
    .voice-btn {
      position: relative;
      width: 100%;
      padding: 1.25rem;
      background: var(--orange);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 8px 32px var(--accent-glow);
      overflow: hidden;
      font-family: inherit;
    }
    
    .voice-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.2);
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .voice-btn:hover::before {
      opacity: 1;
    }
    
    .voice-btn:active {
      transform: scale(0.98);
    }
    
    .voice-btn.listening {
      background: var(--olive);
      color: white;
      box-shadow: 0 0 0 3px var(--orange), 0 8px 32px var(--accent-glow);
    }
    
    .voice-btn.listening .mic-icon {
      display: none;
    }
    
    .voice-btn.listening .wave-container {
      display: flex;
    }
    
    .mic-icon {
      width: 24px;
      height: 24px;
    }
    
    .wave-container {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 24px;
    }
    
    .wave-bar {
      width: 3px;
      height: 100%;
      background: white;
      border-radius: 2px;
      animation: waveAnim 0.8s ease-in-out infinite;
    }
    
    .wave-bar:nth-child(1) { animation-delay: 0s; height: 40%; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 70%; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 100%; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 60%; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 80%; }
    
    @keyframes waveAnim {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }
    
    .text-row {
      display: flex;
      gap: 0.5rem;
    }
    
    .text-input {
      flex: 1;
      padding: 0.875rem 1rem;
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      color: var(--charcoal);
      font-size: 0.9375rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .text-input::placeholder {
      color: var(--muted);
    }
    
    .text-input:focus {
      border-color: var(--orange);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    
    .send-btn {
      padding: 0.875rem 1.25rem;
      background: var(--olive);
      border: none;
      border-radius: 50px;
      color: white;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .send-btn:hover {
      background: var(--olive-dark);
    }
    
    .checkout-btn {
      width: 100%;
      padding: 1.125rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
      box-shadow: 0 8px 32px rgba(60, 180, 172, 0.4);
    }
    
    .checkout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(60, 180, 172, 0.5);
    }
    
    .checkout-btn:disabled {
      background: var(--muted);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }
    
    .checkout-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .payment-panel {
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 1.25rem;
      padding: 1.5rem;
      margin: 1rem 0;
      animation: panelIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    
    @keyframes panelIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .payment-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }
    
    .payment-header svg {
      width: 18px;
      height: 18px;
      color: var(--teal);
    }
    
    .payment-header h2 {
      font-family: 'Lilita One', cursive;
      font-size: 1rem;
      font-weight: 600;
      color: var(--charcoal);
    }
    
    #payment-element {
      margin-bottom: 1rem;
    }
    
    .pay-btn {
      width: 100%;
      padding: 1rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
      box-shadow: 0 8px 32px rgba(60, 180, 172, 0.4);
    }
    
    .pay-btn:hover {
      transform: translateY(-2px);
    }
    
    .pay-btn:disabled {
      background: var(--muted);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }
    
    .hidden {
      display: none !important;
    }
    
    .status {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.8125rem;
      color: var(--muted);
    }
    
    .status.error {
      color: var(--error);
    }
    
    .success-state {
      text-align: center;
      padding: 2rem 1rem;
      animation: panelIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .success-icon {
      width: 72px;
      height: 72px;
      background: var(--teal);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      box-shadow: 0 12px 40px rgba(60, 180, 172, 0.4);
    }
    
    .success-icon svg {
      width: 36px;
      height: 36px;
      color: white;
    }
    
    .success-state h3 {
      font-family: 'Lilita One', cursive;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--charcoal);
    }
    
    .success-state p {
      color: var(--muted);
    }
    
    .quirky-hint {
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.5rem;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 0.75rem;
      }
      
      header {
        padding: 0.75rem 1rem;
      }
      
      .message {
        max-width: 90%;
      }
    }
    
    /* Mode Toggle */
    .mode-toggle-container {
      position: relative;
      z-index: 10;
      background: var(--bg);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      max-width: 480px;
      margin: 0 auto;
      background: white;
      padding: 4px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .mode-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .mode-btn:hover {
      background: rgba(226, 61, 40, 0.08);
      color: var(--primary);
    }
    
    .mode-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(226, 61, 40, 0.3);
    }
    
    /* Order Sections */
    .order-section {
      display: none;
    }
    
    .order-section.active {
      display: block;
    }
    
    /* Menu Section */
    .menu-header {
      text-align: center;
      padding: 1rem 0 0.5rem;
    }
    
    .menu-title {
      font-family: 'Lilita One', cursive;
      font-size: 1.75rem;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .menu-subtitle {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .menu-categories {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .menu-categories::-webkit-scrollbar {
      display: none;
    }
    
    .category-btn {
      flex-shrink: 0;
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .category-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .category-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-bottom: 16px;
      max-height: 45vh;
      overflow-y: auto;
    }
    
    .menu-item {
      background: white;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .menu-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border-color: rgba(226, 61, 40, 0.2);
    }
    
    .menu-item:active {
      transform: scale(0.98);
    }
    
    .menu-item.in-cart {
      border-color: var(--primary);
      background: rgba(226, 61, 40, 0.03);
    }
    
    .menu-item-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .menu-item-photo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      margin: 0 auto 8px;
    }
    
    .menu-item-name {
      font-family: 'Lilita One', cursive;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.2;
    }
    
    .menu-item-price {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
    }
    
    .menu-item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }
    
    .menu-tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .menu-tag.vegetarian {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .menu-tag.vegan {
      background: #e8f5e9;
      color: #1b5e20;
    }
    
    .menu-tag.gluten-free {
      background: #fff3e0;
      color: #e65100;
    }
    
    .menu-tag.spicy {
      background: #ffebee;
      color: #c62828;
    }
    
    .menu-tag.dairy-free {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .menu-item-qty {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
    }
    
    .qty-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .qty-btn:hover {
      transform: scale(1.1);
    }
    
    .qty-btn.minus {
      background: #f5f5f5;
      color: var(--text-muted);
    }
    
    .qty-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      min-width: 24px;
    }
    
    .loading-menu {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    .loading-menu .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .add-feedback {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--text);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 100;
    }
    
    .add-feedback.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <div class="glow-bg"></div>
  
  <header>
    <a href="/" class="header-logo" style="text-decoration:none;">OrderFi</a>
    <nav class="top-nav">
      <a href="/">Home</a>
      <a href="/order" class="active">Voice Order</a>
      <a href="/menu/loose-moose">Menu</a>
      <a href="/kitchen">Kitchen</a>
      <a href="/admin">Dashboard</a>
    </nav>
    <button class="focus-toggle" onclick="document.body.classList.toggle('focus-mode')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      Focus
    </button>
  </header>
  
  <!-- Order Mode Toggle -->
  <div class="mode-toggle-container">
    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="voice" onclick="switchOrderMode('voice')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        </svg>
        Voice Order
      </button>
      <button class="mode-btn" data-mode="menu" onclick="switchOrderMode('menu')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
        Browse Menu
      </button>
    </div>
  </div>
  
  <div class="container">
    <!-- Voice Ordering Section -->
    <div id="voice-section" class="order-section active">
      <div class="chat-area" id="chat"></div>
    </div>
    
    <!-- Menu Browsing Section -->
    <div id="menu-section" class="order-section">
      <div class="menu-header">
        <h2 class="menu-title">Fresh Flavors</h2>
        <p class="menu-subtitle">Tap to add to your order</p>
      </div>
      
      <div class="menu-categories" id="menu-categories">
        <button class="category-btn active" data-category="all" onclick="filterMenuCategory('all')">All</button>
      </div>
      
      <div class="menu-grid" id="menu-grid">
        <div class="loading-menu">
          <div class="spinner"></div>
          <p>Loading menu...</p>
        </div>
      </div>
    </div>
    
    <div class="order-panel" id="order-panel">
      <div class="order-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <h2>Your Order</h2>
      </div>
      <div id="order-items">
        <p class="order-empty">Nothing yet â€” say something delicious!</p>
      </div>
    </div>
    
    <div id="payment-section" class="hidden">
      <div class="payment-panel">
        <div class="payment-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
            <line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
          <h2>Payment</h2>
        </div>
        <div id="payment-element"></div>
        <button id="pay-btn" class="pay-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Complete Order
        </button>
        <div id="payment-status" class="status"></div>
      </div>
    </div>
    
    <div class="controls">
      <button id="voice-btn" class="voice-btn">
        <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
        </svg>
        <div class="wave-container">
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>
        <span id="voice-text">Hold to speak</span>
      </button>
      
      <div class="text-row">
        <input type="text" id="text-input" class="text-input" placeholder="or type here...">
        <button id="send-btn" class="send-btn">Send</button>
      </div>
      
      <button id="checkout-btn" class="checkout-btn hidden">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
          <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        Pay now
      </button>
      
      <p class="quirky-hint" id="hint">Tip: Just say what you want. No menus needed.</p>
    </div>
    
    <div id="status" class="status"></div>
  </div>

  <script>
    const sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
    let currentOrder = [];
    let total = 0;
    let stripe, elements, paymentElement;
    
    const quirkyHints = [
      "Tip: Just say what you want. No menus needed.",
      "Pro move: Change your mind mid-sentence. We get it.",
      "Fun fact: Your voice is the new touch screen.",
      "Hungry thought: Pizza counts as a vegetable, right?",
      "Order hack: \"Same as last time\" works too.",
    ];
    
    const chatEl = document.getElementById('chat');
    const orderItemsEl = document.getElementById('order-items');
    const voiceBtn = document.getElementById('voice-btn');
    const voiceText = document.getElementById('voice-text');
    const textInput = document.getElementById('text-input');
    const sendBtn = document.getElementById('send-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const paymentSection = document.getElementById('payment-section');
    const payBtn = document.getElementById('pay-btn');
    const statusEl = document.getElementById('status');
    const paymentStatus = document.getElementById('payment-status');
    const hintEl = document.getElementById('hint');
    
    let hintIndex = 0;
    setInterval(() => {
      hintIndex = (hintIndex + 1) % quirkyHints.length;
      if (hintEl) {
        hintEl.style.opacity = '0';
        setTimeout(() => {
          hintEl.textContent = quirkyHints[hintIndex];
          hintEl.style.opacity = '0.7';
        }, 300);
      }
    }, 8000);
    
    // Menu browsing state
    let menuItems = [];
    let menuCategories = new Set(['all']);
    let currentCategory = 'all';
    let menuCartQuantities = {}; // Track quantities per menu item
    
    // Category icons for display
    const categoryIcons = {
      'Mains': 'ðŸ½ï¸',
      'Appetizers': 'ðŸ¥—',
      'Drinks': 'ðŸ¥¤',
      'Desserts': 'ðŸ°',
      'Sides': 'ðŸŸ',
      'Salads': 'ðŸ¥¬',
      'Soups': 'ðŸœ',
      'Pizza': 'ðŸ•',
      'Burgers': 'ðŸ”',
      'Sushi': 'ðŸ£',
      'Seafood': 'ðŸ¦',
      'default': 'ðŸ´'
    };
    
    // Food item icons based on name keywords
    function getFoodIcon(name, category) {
      const lowerName = name.toLowerCase();
      if (lowerName.includes('burger')) return 'ðŸ”';
      if (lowerName.includes('pizza')) return 'ðŸ•';
      if (lowerName.includes('taco')) return 'ðŸŒ®';
      if (lowerName.includes('salad')) return 'ðŸ¥—';
      if (lowerName.includes('pasta') || lowerName.includes('spaghetti')) return 'ðŸ';
      if (lowerName.includes('sushi')) return 'ðŸ£';
      if (lowerName.includes('ramen') || lowerName.includes('noodle') || lowerName.includes('bowl')) return 'ðŸœ';
      if (lowerName.includes('smoothie') || lowerName.includes('juice')) return 'ðŸ§ƒ';
      if (lowerName.includes('coffee')) return 'â˜•';
      if (lowerName.includes('tea')) return 'ðŸµ';
      if (lowerName.includes('steak') || lowerName.includes('ribs')) return 'ðŸ¥©';
      if (lowerName.includes('chicken') || lowerName.includes('wing')) return 'ðŸ—';
      if (lowerName.includes('fish') || lowerName.includes('salmon')) return 'ðŸŸ';
      if (lowerName.includes('shrimp') || lowerName.includes('prawn')) return 'ðŸ¦';
      if (lowerName.includes('cake') || lowerName.includes('dessert')) return 'ðŸ°';
      if (lowerName.includes('ice cream')) return 'ðŸ¨';
      if (lowerName.includes('fries')) return 'ðŸŸ';
      if (lowerName.includes('soup')) return 'ðŸ¥£';
      if (lowerName.includes('sandwich') || lowerName.includes('wrap')) return 'ðŸ¥ª';
      if (lowerName.includes('egg') || lowerName.includes('breakfast')) return 'ðŸ³';
      return categoryIcons[category] || categoryIcons['default'];
    }
    
    // Switch between Voice and Menu modes
    function switchOrderMode(mode) {
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      document.getElementById('voice-section').classList.toggle('active', mode === 'voice');
      document.getElementById('menu-section').classList.toggle('active', mode === 'menu');
      
      // Load menu when switching to menu mode
      if (mode === 'menu' && menuItems.length === 0) {
        loadMenuItems();
      }
    }
    
    // Load menu items from API
    async function loadMenuItems() {
      try {
        const res = await fetch('/api/menu');
        if (!res.ok) throw new Error('Failed to load menu');
        menuItems = await res.json();
        
        // Extract unique categories
        menuCategories = new Set(['all']);
        menuItems.forEach(item => {
          if (item.category) menuCategories.add(item.category);
        });
        
        renderMenuCategories();
        renderMenuItems();
      } catch (e) {
        console.error('Error loading menu:', e);
        document.getElementById('menu-grid').innerHTML = `
          <div class="loading-menu">
            <p>Failed to load menu. Please try again.</p>
          </div>
        `;
      }
    }
    
    // Render category filter buttons
    function renderMenuCategories() {
      const container = document.getElementById('menu-categories');
      container.innerHTML = Array.from(menuCategories).map(cat => `
        <button class="category-btn ${cat === currentCategory ? 'active' : ''}" 
                data-category="${cat}" 
                onclick="filterMenuCategory('${cat}')">
          ${cat === 'all' ? 'All' : cat}
        </button>
      `).join('');
    }
    
    // Filter by category
    function filterMenuCategory(category) {
      currentCategory = category;
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === category);
      });
      renderMenuItems();
    }
    
    // Render menu items grid
    function renderMenuItems() {
      const filtered = currentCategory === 'all' 
        ? menuItems 
        : menuItems.filter(item => item.category === currentCategory);
      
      if (filtered.length === 0) {
        document.getElementById('menu-grid').innerHTML = `
          <div class="loading-menu">
            <p>No items in this category yet.</p>
          </div>
        `;
        return;
      }
      
      document.getElementById('menu-grid').innerHTML = filtered.map(item => {
        const qty = menuCartQuantities[item.id] || 0;
        const inCart = qty > 0;
        const icon = getFoodIcon(item.name, item.category);
        const tags = item.dietaryTags || [];
        
        return `
          <div class="menu-item ${inCart ? 'in-cart' : ''}" data-id="${item.id}">
            ${item.photoUrl 
              ? `<img src="${item.photoUrl}" alt="${item.name}" class="menu-item-photo">`
              : `<div class="menu-item-icon">${icon}</div>`
            }
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">$${parseFloat(item.price).toFixed(2)}</div>
            <div class="menu-item-tags">
              ${tags.map(tag => `<span class="menu-tag ${tag.toLowerCase().replace(/\s+/g, '-')}">${tag}</span>`).join('')}
            </div>
            ${inCart ? `
              <div class="menu-item-qty">
                <button class="qty-btn minus" onclick="event.stopPropagation(); adjustMenuQty(${item.id}, -1)">âˆ’</button>
                <span class="qty-value">${qty}</span>
                <button class="qty-btn plus" onclick="event.stopPropagation(); adjustMenuQty(${item.id}, 1)">+</button>
              </div>
            ` : `
              <div class="menu-item-qty" style="border-top: none; padding-top: 6px;">
                <button class="qty-btn plus" onclick="event.stopPropagation(); addToCartFromMenu(${item.id})" style="width: auto; padding: 6px 16px; border-radius: 16px;">
                  Add +
                </button>
              </div>
            `}
          </div>
        `;
      }).join('');
    }
    
    // Add item from menu to cart
    function addToCartFromMenu(itemId) {
      const item = menuItems.find(m => m.id === itemId);
      if (!item) return;
      
      menuCartQuantities[itemId] = (menuCartQuantities[itemId] || 0) + 1;
      
      // Update the shared order
      const existingIndex = currentOrder.findIndex(o => o.id === itemId);
      if (existingIndex >= 0) {
        currentOrder[existingIndex].quantity = menuCartQuantities[itemId];
      } else {
        currentOrder.push({
          id: itemId,
          name: item.name,
          price: parseFloat(item.price),
          quantity: 1
        });
      }
      
      updateOrderDisplay();
      renderMenuItems();
      showAddFeedback(`Added ${item.name}!`);
    }
    
    // Adjust quantity from menu
    function adjustMenuQty(itemId, delta) {
      const item = menuItems.find(m => m.id === itemId);
      if (!item) return;
      
      const newQty = (menuCartQuantities[itemId] || 0) + delta;
      
      if (newQty <= 0) {
        delete menuCartQuantities[itemId];
        currentOrder = currentOrder.filter(o => o.id !== itemId);
      } else {
        menuCartQuantities[itemId] = newQty;
        const existingIndex = currentOrder.findIndex(o => o.id === itemId);
        if (existingIndex >= 0) {
          currentOrder[existingIndex].quantity = newQty;
        }
      }
      
      updateOrderDisplay();
      renderMenuItems();
    }
    
    // Show add feedback toast
    function showAddFeedback(message) {
      let feedback = document.querySelector('.add-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'add-feedback';
        document.body.appendChild(feedback);
      }
      feedback.textContent = message;
      feedback.classList.add('show');
      setTimeout(() => feedback.classList.remove('show'), 1500);
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, 'user');
        processVoice(transcript);
      };
      
      recognition.onend = () => {
        isListening = false;
        voiceBtn.classList.remove('listening');
        voiceText.textContent = 'Hold to speak';
      };
      
      recognition.onerror = (event) => {
        console.error('Speech error:', event.error);
        statusEl.textContent = 'Mic hiccup â€” try typing instead';
        statusEl.className = 'status error';
        isListening = false;
        voiceBtn.classList.remove('listening');
      };
    }
    
    voiceBtn.addEventListener('mousedown', startListening);
    voiceBtn.addEventListener('mouseup', stopListening);
    voiceBtn.addEventListener('mouseleave', stopListening);
    voiceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startListening(); });
    voiceBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopListening(); });
    
    function startListening() {
      if (!recognition) {
        statusEl.textContent = 'Voice not available â€” type instead!';
        statusEl.className = 'status error';
        return;
      }
      isListening = true;
      voiceBtn.classList.add('listening');
      voiceText.textContent = 'Listening...';
      recognition.start();
    }
    
    function stopListening() {
      if (recognition && isListening) {
        recognition.stop();
      }
    }
    
    sendBtn.addEventListener('click', sendText);
    textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendText();
    });
    
    function sendText() {
      const text = textInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      processVoice(text);
      textInput.value = '';
    }
    
    function addMessage(text, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    
    function showTyping() {
      const div = document.createElement('div');
      div.className = 'typing';
      div.id = 'typing';
      div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    
    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }
    
    async function processVoice(transcript) {
      try {
        statusEl.textContent = '';
        showTyping();
        
        const res = await fetch('/api/voice/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript, sessionId }),
        });
        
        const data = await res.json();
        
        hideTyping();
        addMessage(data.message, 'assistant');
        speak(data.message);
        
        currentOrder = data.currentOrder || [];
        total = parseFloat(data.total) || 0;
        updateOrderDisplay();
        
      } catch (error) {
        console.error('Error:', error);
        hideTyping();
        statusEl.textContent = 'Oops, something broke. Try again?';
        statusEl.className = 'status error';
      }
    }
    
    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
      }
    }
    
    function removeFromOrder(index) {
      if (currentOrder[index]) {
        if (currentOrder[index].quantity > 1) {
          currentOrder[index].quantity--;
          total -= currentOrder[index].price;
        } else {
          total -= currentOrder[index].price;
          currentOrder.splice(index, 1);
        }
        updateOrderDisplay();
      }
    }
    
    window.removeFromOrder = removeFromOrder;
    
    function updateOrderDisplay() {
      if (currentOrder.length === 0) {
        orderItemsEl.innerHTML = '<p class="order-empty">Nothing yet â€” say something delicious!</p>';
        checkoutBtn.classList.add('hidden');
        return;
      }
      
      let html = '';
      currentOrder.forEach((item, index) => {
        html += `
          <div class="order-item">
            <div class="order-item-info">
              <button class="order-item-remove" onclick="removeFromOrder(${index})" title="Remove item">Ã—</button>
              <span class="order-item-name">${item.quantity}x ${item.name}</span>
            </div>
            <span class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        `;
      });
      
      const tax = total * 0.08;
      const grandTotal = total + tax;
      
      html += `
        <div class="order-divider"></div>
        <div class="order-row">
          <span>Subtotal</span>
          <span>$${total.toFixed(2)}</span>
        </div>
        <div class="order-row">
          <span>Tax</span>
          <span>$${tax.toFixed(2)}</span>
        </div>
        <div class="order-row total">
          <span>Total</span>
          <span>$${grandTotal.toFixed(2)}</span>
        </div>
      `;
      
      orderItemsEl.innerHTML = html;
      checkoutBtn.classList.remove('hidden');
    }
    
    checkoutBtn.addEventListener('click', async () => {
      try {
        checkoutBtn.disabled = true;
        statusEl.textContent = 'Setting up payment...';
        statusEl.className = 'status';
        
        const configRes = await fetch('/api/payment/config');
        const config = await configRes.json();
        
        stripe = Stripe(config.publishableKey);
        
        const intentRes = await fetch('/api/payment/create-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId }),
        });
        
        const intent = await intentRes.json();
        
        if (intent.error) {
          statusEl.textContent = intent.error;
          statusEl.className = 'status error';
          checkoutBtn.disabled = false;
          return;
        }
        
        elements = stripe.elements({ 
          clientSecret: intent.clientSecret,
          appearance: {
            theme: 'stripe',
            variables: {
              colorPrimary: '#3CB4AC',
              colorBackground: '#ffffff',
              colorText: '#2D2D2D',
              colorDanger: '#ef4444',
              borderRadius: '12px',
            }
          }
        });
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
        paymentSection.classList.remove('hidden');
        checkoutBtn.classList.add('hidden');
        statusEl.textContent = '';
        
      } catch (error) {
        console.error('Checkout error:', error);
        statusEl.textContent = 'Payment setup failed. Try again?';
        statusEl.className = 'status error';
        checkoutBtn.disabled = false;
      }
    });
    
    payBtn.addEventListener('click', async () => {
      payBtn.disabled = true;
      paymentStatus.textContent = 'Processing...';
      paymentStatus.className = 'status';
      
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '/success',
        },
        redirect: 'if_required',
      });
      
      if (error) {
        paymentStatus.textContent = error.message;
        paymentStatus.className = 'status error';
        payBtn.disabled = false;
      } else {
        paymentSection.querySelector('.payment-panel').innerHTML = `
          <div class="success-state">
            <div class="success-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <h3>You're all set!</h3>
            <p>Your food is on its way. Time to get excited.</p>
          </div>
        `;
        speak("You're all set! Your food is on its way.");
      }
    });
    
    setTimeout(() => {
      const greetings = [
        "Hey there! What sounds good today?",
        "Hi! I'm ready when you are. What are we eating?",
        "Welcome back! What's the craving?",
      ];
      const greeting = greetings[Math.floor(Math.random() * greetings.length)];
      addMessage(greeting, 'assistant');
      speak(greeting);
    }, 600);
  </script>
</body>
</html>
