<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrderFi Voice Ordering</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fff;
      color: #1f2937;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #f97316;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .container {
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      width: 100%;
    }
    
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
      min-height: 300px;
      max-height: 50vh;
    }
    
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 85%;
    }
    
    .message.user {
      background: #f97316;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.assistant {
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 0.25rem;
    }
    
    .order-summary {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .order-summary h3 {
      color: #f97316;
      margin-bottom: 0.5rem;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
    }
    
    .order-total {
      border-top: 1px solid #fed7aa;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      font-weight: 600;
    }
    
    .controls {
      padding: 1rem 0;
      border-top: 1px solid #e5e7eb;
    }
    
    .voice-btn {
      width: 100%;
      padding: 1rem;
      background: #f97316;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }
    
    .voice-btn:hover {
      background: #ea580c;
    }
    
    .voice-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .voice-btn.listening {
      background: #dc2626;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .text-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .text-input input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    
    .text-input button {
      padding: 0.75rem 1.5rem;
      background: #1f2937;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 1rem;
      background: #16a34a;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .checkout-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    #payment-element {
      margin: 1rem 0;
    }
    
    .hidden {
      display: none;
    }
    
    .status {
      text-align: center;
      padding: 0.5rem;
      color: #6b7280;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>OrderFi Voice Ordering</h1>
  </div>
  
  <div class="container">
    <div class="chat-container" id="chat"></div>
    
    <div class="order-summary" id="order-summary">
      <h3>Your Order</h3>
      <div id="order-items">
        <p style="color: #9ca3af;">No items yet. Start ordering!</p>
      </div>
    </div>
    
    <div id="payment-section" class="hidden">
      <div id="payment-element"></div>
      <button id="pay-btn" class="checkout-btn">Pay Now</button>
      <div id="payment-status" class="status"></div>
    </div>
    
    <div class="controls">
      <button id="voice-btn" class="voice-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
        <span id="voice-text">Hold to Speak</span>
      </button>
      
      <div class="text-input">
        <input type="text" id="text-input" placeholder="Or type your order...">
        <button id="send-btn">Send</button>
      </div>
      
      <button id="checkout-btn" class="checkout-btn hidden">Proceed to Payment</button>
    </div>
    
    <div id="status" class="status"></div>
  </div>

  <script>
    const sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
    let currentOrder = [];
    let total = 0;
    let stripe, elements, paymentElement;
    
    const chatEl = document.getElementById('chat');
    const orderItemsEl = document.getElementById('order-items');
    const voiceBtn = document.getElementById('voice-btn');
    const voiceText = document.getElementById('voice-text');
    const textInput = document.getElementById('text-input');
    const sendBtn = document.getElementById('send-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const paymentSection = document.getElementById('payment-section');
    const payBtn = document.getElementById('pay-btn');
    const statusEl = document.getElementById('status');
    const paymentStatus = document.getElementById('payment-status');
    
    // Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;
    
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, 'user');
        processVoice(transcript);
      };
      
      recognition.onend = () => {
        isListening = false;
        voiceBtn.classList.remove('listening');
        voiceText.textContent = 'Hold to Speak';
      };
      
      recognition.onerror = (event) => {
        console.error('Speech error:', event.error);
        statusEl.textContent = 'Speech recognition error. Try typing instead.';
        isListening = false;
        voiceBtn.classList.remove('listening');
      };
    }
    
    // Voice button
    voiceBtn.addEventListener('mousedown', startListening);
    voiceBtn.addEventListener('mouseup', stopListening);
    voiceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startListening(); });
    voiceBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopListening(); });
    
    function startListening() {
      if (!recognition) {
        statusEl.textContent = 'Voice not supported. Use text input.';
        return;
      }
      isListening = true;
      voiceBtn.classList.add('listening');
      voiceText.textContent = 'Listening...';
      recognition.start();
    }
    
    function stopListening() {
      if (recognition && isListening) {
        recognition.stop();
      }
    }
    
    // Text input
    sendBtn.addEventListener('click', sendText);
    textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendText();
    });
    
    function sendText() {
      const text = textInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      processVoice(text);
      textInput.value = '';
    }
    
    // Add message to chat
    function addMessage(text, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    
    // Process voice/text
    async function processVoice(transcript) {
      try {
        statusEl.textContent = 'Processing...';
        
        const res = await fetch('/api/voice/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript, sessionId }),
        });
        
        const data = await res.json();
        
        addMessage(data.message, 'assistant');
        speak(data.message);
        
        currentOrder = data.currentOrder || [];
        total = parseFloat(data.total) || 0;
        updateOrderDisplay();
        
        statusEl.textContent = '';
      } catch (error) {
        console.error('Error:', error);
        statusEl.textContent = 'Error processing request';
      }
    }
    
    // Text-to-speech
    function speak(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
      }
    }
    
    // Update order display
    function updateOrderDisplay() {
      if (currentOrder.length === 0) {
        orderItemsEl.innerHTML = '<p style="color: #9ca3af;">No items yet. Start ordering!</p>';
        checkoutBtn.classList.add('hidden');
        return;
      }
      
      let html = '';
      currentOrder.forEach(item => {
        html += `
          <div class="order-item">
            <span>${item.quantity}x ${item.name}</span>
            <span>$${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        `;
      });
      
      const tax = total * 0.08;
      const grandTotal = total + tax;
      
      html += `
        <div class="order-total">
          <div class="order-item">
            <span>Subtotal</span>
            <span>$${total.toFixed(2)}</span>
          </div>
          <div class="order-item">
            <span>Tax</span>
            <span>$${tax.toFixed(2)}</span>
          </div>
          <div class="order-item" style="font-weight: 700;">
            <span>Total</span>
            <span>$${grandTotal.toFixed(2)}</span>
          </div>
        </div>
      `;
      
      orderItemsEl.innerHTML = html;
      checkoutBtn.classList.remove('hidden');
    }
    
    // Checkout
    checkoutBtn.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Setting up payment...';
        
        // Get Stripe config
        const configRes = await fetch('/api/payment/config');
        const config = await configRes.json();
        
        stripe = Stripe(config.publishableKey);
        
        // Create payment intent - server calculates amount from session
        const intentRes = await fetch('/api/payment/create-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId }),
        });
        
        const intent = await intentRes.json();
        
        if (intent.error) {
          statusEl.textContent = intent.error;
          return;
        }
        
        // Setup payment element
        elements = stripe.elements({ clientSecret: intent.clientSecret });
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
        paymentSection.classList.remove('hidden');
        checkoutBtn.classList.add('hidden');
        statusEl.textContent = '';
        
      } catch (error) {
        console.error('Checkout error:', error);
        statusEl.textContent = 'Failed to setup payment';
      }
    });
    
    // Pay
    payBtn.addEventListener('click', async () => {
      payBtn.disabled = true;
      paymentStatus.textContent = 'Processing payment...';
      
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: window.location.origin + '/success',
        },
        redirect: 'if_required',
      });
      
      if (error) {
        paymentStatus.textContent = error.message;
        payBtn.disabled = false;
      } else {
        paymentStatus.textContent = 'Payment successful! Your order is being prepared.';
        paymentSection.innerHTML = '<p style="text-align:center;padding:2rem;color:#16a34a;font-weight:600;">Payment Complete! Your order is confirmed.</p>';
        speak('Payment successful! Your order is being prepared.');
      }
    });
    
    // Initial greeting
    setTimeout(() => {
      const greeting = "Hi! I'm Mimi. What would you like to order today?";
      addMessage(greeting, 'assistant');
      speak(greeting);
    }, 500);
  </script>
</body>
</html>
